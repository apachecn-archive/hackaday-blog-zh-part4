# 本周安全:IPhone 未通电，Python 未装箱，巫师蜘蛛未蒙面

> 原文：<https://hackaday.com/2022/05/20/this-week-in-security-iphone-unpowered-python-unsandboxed-and-wizard-spider-unmasked/>

就阴谋论而言，更合理的说法之一是，手机可能在其基带处理器上运行恶意固件，即使关机也能监听和传输数据。如今，这种行为被称为功能，至少如果你的手机是苹果公司制造的，有“查找我”的功能。即使在手机关机的情况下，蓝牙芯片也能在低功耗状态下愉快地运行，使这些功能发挥作用。问题是这个芯片不做签名固件。只需对手机主操作系统进行根级访问，就可以将潜在的恶意固件映像加载到蓝牙芯片上。

德国达姆施塔特大学的研究人员展示了这种方法，[写了一篇关于他们工作的优秀论文(PDF)](https://arxiv.org/pdf/2205.06114.pdf) 。这项研究提出了一些非常有趣的可能性。最简单的是劫持苹果的“查找我的系统”来追踪手机关机的人。更大的危险是，这可能被用来在设备上保留监视恶意软件，即使是在电源循环中。设备往往能够很好地抵御来自外部网络的攻击，而几乎无法抵御来自芯片本身的攻击。不幸的是，由于未签名的固件是一种硬件限制，除了防止攻击者破坏操作系统的正常努力之外，安全更新无法缓解这种情况。


## 蓝牙低能耗

这又是一个与蓝牙相关的问题，这次是关于用作认证令牌的蓝牙低能量(BLE)。你可能已经以这样或那样的形式看到过这个想法，比如 Android 的选项，无论何时连接到你的 BLE 耳塞都保持解锁。它用于各种车辆，一旦合适的手机在 BLE 范围内解锁。

使用 BLE 进行这种认证一直是一个糟糕的主意，因为 BLE 很容易受到空中中继攻击。攻击的一半在你的手机旁边，就像汽车的 BLE 芯片，另一半在汽车旁边，欺骗你的手机。连接两个欺骗设备，汽车认为授权电话就在那里。为了使其“安全”，供应商增加了加密功能，以及信号时序分析，以试图捕捉欺骗。

这里真正的创新是使用专用硬件在链路层进行探测和重放。这避免了加密问题，因为信号只是不受干扰地传递。它还加快了进程，即使在数百英里之外的互联网上，延迟也足够低。很可能这种技术的下一次迭代可以简单地使用软件定义的无线电在更低的水平上重放信号。解决方案是在解锁车辆之前提示用户授权，或者在加密的有效载荷中嵌入位置信息。

 [https://www.youtube.com/embed/HF-tAujvckA?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent](https://www.youtube.com/embed/HF-tAujvckA?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent)



## Python 缓冲区熔断

这是[其中一个没什么大不了的问题，但在某些情况下可能会成为](https://pwn.win/2022/05/11/python-buffered-reader.html)的一个问题。这一切都始于 2012 年，当时人们发现 Python `memoryview`对象在指向一个不再有效的内存位置时会导致程序崩溃。一个`memoryview`本质上是一个指向底层 C 缓冲区的指针，并不像普通的 Python 对象那样自动引用计数。解除分配`memoryview`指向的对象，然后针对一些 C 风格的未定义行为解除对这个“指针”的引用。(这里我们不是指被诅咒的代码，而是更普通的 UD——取消对不再有效的指针的引用。)一点内存操作就可以很好地控制原始指针值，将它设置为 NULL 会导致解释器崩溃。

这实际上是一个读写原语。窥探 Python 的内存，找到 ELF 头文件，然后找出 glibc `system`动态库在过程链接表中的位置。找到它，使用内存损坏 bug 跳转到内存中的适当位置，然后嘣，您就从 Python 弹出了一个 shell！

你们中更精明的人肯定已经在想，哎呀，这是一种令人费解的称呼`os.system()`。是的，作为一个漏洞，[它很不起眼](https://github.com/python/cpython/issues/60198#issuecomment-1126948055)。[kn32]，我们对 Python 这一怪癖的导游指出，它可以用来逃离 Python 沙箱，但这是一个非常小的用例。即使我们断定这不是真正的利用，但它是一个很好的学习工具，也是一些有趣的黑客技术。

## 巫师蜘蛛

当一群聪明且高度积极的研究人员，如 PRODRAFT 的人，将他们的网站放在一个大型勒索软件团伙上时，会发生什么？首先，他们必须想出一个吸引人的名字。他们决定将这种恶意软件团伙称为“巫师蜘蛛”——从这一点上得到了一些强烈的 D&D 氛围。

PDF 报告详细描述了这些发现，它们令人印象深刻。调查描绘了 WS 的工具选择，以及他们的一些基础设施，如他们用来代理他们的行动的 Wireguard 隧道网络。最有趣的是发现了一个备份服务器，据信位于俄罗斯，其中也包含与 REvil 攻击相对应的备份。关于这一发现到底表明了什么，有很多理论。这份报告的另一个版本已经交给了执法部门，可能包含了更多的身份信息。

这里讨论了一些值得注意的技术，包括一个机器学习引擎，它可以查看写作，并尝试确定作者的母语。这是有原因的，比如省略冠词，比如“the”，以及使用错误的动词时态。一些看起来奇怪的英语短语是母语中常见表达的逐字翻译。在一个没有人感到惊讶的结论中，PRODRAFT 确定 WS 的官方发言人是一位母语为俄语的人。希望这个信息宝藏背后的故事能够被分享。这将会是一个黑客入侵的故事，也许还会是一些老式的贸易方式。

## 揭露 Parallels 黑客

在 Pwn2own 2021 期间，RET2 系统[的【Jack Dates】成功攻破了 Parallels VM](https://youtu.be/smav9ljrgSE?t=837) 。令我们高兴的是，他[为我们的教育写了剥削过程](https://blog.ret2.io/2022/05/19/pwn2own-2021-parallels-desktop-exploit/)。guest additions 代码中的一系列错误使得一个链能够逃离 guest。使用的第一个 bug 是信息泄漏，其中 0x20 字节被写入大小为 0x90 的缓冲区，然后整个缓冲区暴露给 guest 虚拟机。这是一次可以读取的 0x70 字节的主机虚拟机堆内存，只够计算出一些基址。

下一个错误是拖放处理代码中的缓冲区溢出。传递给宿主的结构包含一个以 null 结尾的字符串，跳过 null 会导致缓冲区溢出到堆栈上。此溢出可用于破坏主机上运行的来宾添加代码的异常处理。第三个 bug 是所谓的“megasmash ”,它看起来不是很有用，因为它溢出一个整数来触发大规模缓冲区溢出。使用这个函数的问题是，当它溢出时，它试图在程序内存上写`0xffffffff`字节。该链确实使用它来修改回调指针以指向恶意代码。但是，某些内存肯定是只读的，会触发异常。

这里的关键是异常处理被篡改了，所以当异常被触发时，处理代码立即出错并挂起，阻止了正常的程序清理。然后，其他线程可以命中被篡改的函数指针，导致代码执行。去年年底，发现的漏洞都被修复了，而[杰克]为这个漏洞链赚了 4 万美元。尽情享受吧！