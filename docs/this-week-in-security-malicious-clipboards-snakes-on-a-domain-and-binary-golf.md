# 本周安全:恶意剪贴板、域中的蛇和二元高尔夫

> 原文：<https://hackaday.com/2022/09/02/this-week-in-security-malicious-clipboards-snakes-on-a-domain-and-binary-golf/>

对于 Chromium、谷歌 Chrome、系统剪贴板，以及谷歌在新标签页上的涂鸦，有一点恐慌。都是关于[铬问题 1334203，“NewTabPageDoodleShareDialogFocusTest。当强制执行用户手势"](https://bugs.chromium.org/p/chromium/issues/detail?id=1334203)时，所有测试失败。你看，Chromium 有一个相当大的回归测试套件，谷歌工程师希望确保谷歌涂鸦总是工作。添加到剪贴板处理 API 的一个安全特性碰巧破坏了涂鸦测试，所以为了修复涂鸦，安全特性被部分还原。现在缺失的功能？在页面可以读写剪贴板之前需要用户交互。

现在你明白为什么会有一点恐慌了——是的，听起来真的很糟糕。任意从你的剪贴板中读取页面是彻头彻尾的恶意和危险。如果不需要交互，那么任何页面都可以这样做，对吗？不，不完全是。因此，Chrome 有一套保护措施，如果用户没有与页面互动，有些事情是页面不能做的。当试图刷新包含视频通话的页面时，您可能会看到这种不和谐的情况。"单击此页面上的任意位置以启用视频。"这是为了防止恼人的自动播放视频和其他恼人的页面行为。最重要的是，这不是防止页面读取剪贴板内容的唯一方法。[自己看](https://async-clipboard-api.glitch.me/)。阅读剪贴板是一个站点权限，就像访问你的相机或麦克风一样。

现在，一个网站确实有可能向剪贴板写东西，并利用它来达到恶意的目的。比如在一个号称炫耀 Linux 命令行技巧的网站上写`rm -rf /`。但事实一直如此。这就是为什么你应该总是粘贴到一个简单的文本编辑器，而不是直接从一个网站的控制台。所以，真的，没有必要恐慌。Chromium 开发人员试图推出一个稍微更激进的安全措施，发现它破坏了一些不相关的东西，所以部分回滚。天没有塌下来。

## 天要塌了

如果你运行的是 Gitlab 实例，没有抓取 22 日发布的更新，并且启用了从 Github 导入，[你可能会遇到问题](https://about.gitlab.com/releases/2022/08/22/critical-security-release-gitlab-15-3-1-released/)。CVE-2022-2884 允许在导入恶意 Github 存储库时执行任意代码。值得庆幸的是，只有注册用户才能执行这一操作，但仍然存在双重危险:帐户受损，用户无意中导入恶意回购。如果你不能马上更新，你可以禁用 Github 导入来缓解这个问题。

如果你运行的是 Bitbucket 服务器或者 Bitbucket 数据中心实例，并且还没有安装从 21 号开始的[更新，那你可能就有问题了。这些 Atlassian 产品中的多个端点存在命令注入漏洞，如果您的服务器包含公共存储库，这就是预授权攻击。CVE-2022-36804 获得了令人垂涎的 9.9 级 CVSS 评分。](https://confluence.atlassian.com/bitbucketserver/bitbucket-server-and-data-center-advisory-2022-08-24-1155489835.html)

如果你使用 Foxit PDF Editor 或 PhantomPDF，这两个程序已经[发布了实质性的安全更新](https://www.foxit.com/support/security-bulletins.html)，修复了多个 RCE 漏洞。此次更新最显著的元素是将 V8 javascript 引擎升级到最新版本，因为旧的捆绑版本中存在已知的漏洞。我不得不为一个客户部署 Foxit，因为 Adobe PDF reader 在试图查看用 Adobe Photoshop 生成的特定 PDF 时会崩溃。不管我们为什么运行 Foxit，让它保持最新！

## 领地上的蛇

`sysmon.lnk`显示在您的启动文件夹中。那，呃，可能不太好，对吧？这是一个指向可疑文件夹中的可执行文件的链接，`c:\users\\appdata\roaming\PpvcbBQh\ctfmon.exe`，并把`update.py`作为参数传递。这是女猎手大学的研究人员正在调查的情况，故事肯定是掉进了兔子洞——蛇洞？ `ctfmon.exe`实际上是 IronPython 解释器，一个漂亮的运行时，它使 Python 代码能够与`.net`库对话。这就只剩下 Python 脚本了。恶意？是的。我们称之为第一阶段。阶段 2 是一个非常大的 base64 编码字符串，给定一个随机变量名称，解码，然后`exec()`d。典型的混淆东西。

那么有效载荷是做什么的？为了安全地检查这个和其他模糊变量的内容，女猎手的研究人员求助于 [CyberChef](https://gchq.github.io/CyberChef/) ，这是一个漂亮的开源项目，专门用于这种去泡沫化。你猜怎么着，它加载了一些库，然后释放了另一个巨大的字符串。这次是一个. net 可执行文件，阶段 3。它是做什么的？有一个工具可以做到这一点， [dnSpy](https://github.com/dnSpy/dnSpy) 。

阶段 3 解码另一个混淆的字符串，然后启动一个非恶意的`msbuild.exe`进程。然后，它实施“进程空洞化”策略，启动一个受害者进程，并为该进程的运行注入外来代码。由于 MSBuild 是一个受信任的程序，大多数反恶意软件工具不会打扰它。这一针是第 4 阶段，但乐趣并没有结束。这段代码不是。但它是一个开源的执行汇编，本质上是从 Cobalt Strike 逆向工程而来的代码。是的，它也是一个装载机，启动另一个。net 二进制，阶段 5。

是的，我也听到了塞缪尔·杰克逊厌倦飞机上的蛇的回声。第 5 阶段运行一个脚本来修补反恶意软件扫描界面 AMSI，为全面入侵扫清了又一个障碍。最后，它包含另一个混淆的字符串，尽管这个混淆不仅仅是一个简单的 base64 例程。用 Python 写了一个解密程序，他们终于有了 stage 6 二进制，实际的远程访问木马(RAT)。这将完成您所期望的事情，确保持久性到位，下载更新，并联系命令和控制服务器以获取指示。

多好的旅程啊。有人真的想隐藏他们的恶意软件。帖子中有一些妥协的迹象，尽管似乎这个持久性链是为了避免留下静态 IOC 而写的——只需改变最终的加密密钥，整套嵌套玩偶就不同了。

## 二元高尔夫 3

二元高尔夫大奖赛 3 现在结束了，这是一场有趣的比赛，目的是找到最小的文件，使你选择的程序崩溃。这是一个很好的漏洞搜索实践，因为目标是一个简单的崩溃，而不是我们通常覆盖的复杂的漏洞链。最小文件大小挑战通常意味着参赛者要找出导致崩溃的确切原因。写报告、操作程序计数器、实现任意代码执行都有加分，并且最大的加分是为发现的崩溃合并修复。大家都赢了！

既然比赛已经结束，一些参赛作品将会出版，更多的作品将会出版。作为本周的结束，我们有两个这样的条目特别有趣，因为它们是复古的！

## 只有两个字节

[Pierre Kim]和[Alexandre Torres]可能稍微违反了规则，因为[他们通过网络连接向 telnetd 服务](https://pierrekim.github.io/blog/2022-08-24-2-byte-dos-freebsd-netbsd-telnetd-netkit-telnetd-inetutils-telnetd-kerberos-telnetd.html)发送文件。两个字节，这是一个令人印象深刻的壮举。`0xff0xf7`是有效负载，它使基于 1991 年以来的旧 BSD telnetd 的每个 telnetd 客户机崩溃。`0xf` f 是 IAC，解释为命令，`0xf7`理解为擦除字符命令。问题在于，telnetd 二进制文件仍处于连接的协商和身份验证阶段，而且并非所有的初始化步骤都已完成。因为输入处理代码是在这些状态之间共享的，所以一个尚未初始化的指针被解引用。

## 口袋妖怪 RCE

这不是 BGGP3 中的正式条目，但仍然是一个伟大的故事。任天堂的传统是为其游戏机设计附加产品，这些产品在日本短暂销售，在世界其他地方却从未面世。(看着你，64DD。)

一种这样的设备是移动适配器 GB，它将 GameBoy Color/Advance 与移动电话捆绑在一起，用于在线连接。Pokemon Crystal 支持这个小工具，通过向任天堂终端发送 HTTP 请求，然后使用 POP 协议检查响应来进行交易。该响应是 base64 编码的数据结构。在该结构中篡改值会导致崩溃，但这对[Harvey Phillips]，[来说还不够好，他肯定希望在他的 GBC 仿真器](https://xcellerator.github.io/posts/tetsuji/)上执行任意代码。

不要担心，口袋妖怪水晶也支持 Colliseum 战役，你可以用同样的游戏打电话给一个朋友，并通过移动网络一起玩。再次，2001 年！口袋妖怪水晶确实有另一个怪癖，它已经被用于疯狂飞车。 [`0x15`在日版游戏中被用作控制角色](https://glitchcity.wiki/0x1500_control_code_arbitrary_code_execution)，游戏的文本引擎会在试图显示该角色时执行代码跳转。尚不清楚这些控制角色最初的用途是什么，但它们可能是一种变通办法，使游戏可以在 GBC 非常有限的硬件上运行。`0x3F`控制字符做了类似的跳转，但是只是碰巧跳转到移动适配器缓冲区前面几个字节的位置。

因此终于发现了漏洞。发起一场战斗，用你的代码替换保存要转移的，然后用`0x3F 0x00 0x00`作为训练者的名字。远程设备试图显示“想要战斗”文本，但是控制代码触发跳转到这个“移动脚本”。尽管这没有通过竞赛，[哈维]使用 43 字节的外壳代码在屏幕上写了一个“3”。太美了。