# Linux Fu:命名的白日梦

> 原文：<https://hackaday.com/2019/07/12/linux-fu-named-pipe-dreams/>

如果您使用任何现代命令行，您可能会理解管道的概念。管道是将一个程序的输出连接到另一个程序的输入的能力。例如，通过使用管道连接两个简单的命令，可以更容易地查看 Linux 机器上的大型目录的内容:

```
ls | less
```

该命令运行`ls`，并将其输出发送到`less`程序的输入。在 Linux 中，两个命令同时运行，ls 的输出立即显示为 less 的输入。从用户的角度来看，这是一个单一的操作。相比之下，在常规的旧 MSDOS 下，运行这些命令需要两个步骤:

```
ls > SOME_TEMP_FILE
less < SOME_TEMP_FILE
```

最大的不同是,`ls`将运行完成，并将其输出保存为一个文件。然后，`less`命令运行并读取文件。结果是一样的，但时机不同。

你可能想知道为什么我要解释这么简单的概念。还有另一种不常用的管道:命名管道。普通管道连接到一对命令。然而，命名管道有它自己的生命。任何数量的进程都可以对其进行写入和读取。学习命名管道的方法肯定会提高您的 Linux-Fu，所以让我们开始吧！

## 快速示例:构建日志脚本

假设您想要创建一个简单的日志记录工具。当然，制作一个一直运行的守护进程是一个完全不同的主题，但是我只是要创建一个简单且不健壮的脚本。命名管道可以接受来自其他程序的输入行，守护程序可以为每一行加上时间戳，并将其写入文件。这是守护进程:

```
#!/bin/bash
mkfifo /tmp/nplogpipe
while true
do
  read LINE </tmp/nplogpipe
  echo $(date): "$LINE" >>/tmp/nplog.txt
done
```

`mkfifo`命令创建命名管道(先进先出或 FIFO)。旧的脚本可能使用`mknod`来实现这个目的，这也是可行的。如果管道已经存在，该命令将失败，但这无关紧要。之后，读操作等待来自管道的输入。当它到达时，脚本将日期和行写到日志文件中，然后返回获取更多信息。要测试您的快速和脏记录系统，请在后台或在一个终端窗口中运行该脚本。然后在前台或另一个终端中尝试:

```
echo The first log entry >/tmp/nplogpipe
echo Read Hackaday every day >/tmp/nplogpipe
```

您可以再添加几行，然后检查/tmp/nlog.txt 文件。它应该是这样的:

```
Sat Jun 29 07:37:44 CDT 2019: The first log entry
Sat Jun 29 07:39:57 CDT 2019: Read Hackaday every day
```

## 诀窍在于细节

一个小问题:在这种情况下，read 命令在循环中重复执行，但一般来说，当发送方进程退出时，它会导致接收方程序也退出。这并不总是你想要的行为。处理这种情况的通常方法是打开管道，使管道保持打开，直到关闭。

要观察这种效果，请尝试以下方法(在守护程序运行的情况下):

```
ls / >/tmp/nplogpipe
```

日志将只获取 ls 的第一行。这是因为当它处理完第一行时，ls 命令已经退出并清空了管道。现在试试这个:

```
exec 3>/tmp/nplogpipe
ls / >&3
free >/tmp/nplogpipe
exec 3>&-  # close pipe
```

第一个 exec 行保持管道打开，直到最后一行将其关闭。一旦打开，你可以用&3 或它的全名来指代管道。现在所有的输出都将出现在日志文件中。

另一个细微差别是管道看起来有点像一个文件。这意味着需要文件的程序通常可以使用管道。这也意味着您可以使用与文件相同的安全机制来控制对管道的访问(例如，chmod 为特定用户或组设置权限)。

## 为什么要使用命名管道？

您可能想知道与常规管道或文件相比，它们有什么优势。与普通锉刀不同，管子不会被填满。这也意味着它有更多的机会留在内存中，当然，它可以像其他任何内存一样被换出。此外，一个命名管道很容易有多个写入者。

当然，还有其他需要担心的问题。例如，如果多个程序一次向管道中写入多行数据，您必须制定自己的方案来将它们全部排序。尽管如此，对于在可能不相关的进程之间推送和收集数据的快速方法，命名管道是一种简单的方法。

对了，这是 Linux Fu 的第二十期！下面的链接将会带你去看更早的帖子，敬请期待更多。