# 本周安全:打印 Shellz，Ms-officecmd 和 AI 安全

> 原文：<https://hackaday.com/2021/12/10/this-week-in-security-printing-shellz-ms-officecmd-and-ai-security/>

f-secure 的研究人员开发了一种令人印象深刻的新攻击，利用惠普打印机作为意想不到的攻击面。[Printing Shellz](https://labs.f-secure.com/publications/printing-shellz)([PDF](https://labs.f-secure.com/assets/BlogFiles/Printing-Shellz.pdf))是一种一键式攻击，只要访问一个恶意网页，就足以让一个外壳和反向代理安装到同一网络的打印机上。下面的演示使用跨站点打印(XSP)攻击，在没有任何进一步交互的情况下将恶意打印作业发送到打印机。

[https://player.vimeo.com/video/642270739](https://player.vimeo.com/video/642270739)

用来敲门砖的漏洞在于如何解析 Type 2 字体。这些字体描述符中使用的字符串本质上是它们自己的小程序，在打印机上运行以定义字体中的每个符号。毫不奇怪，这些小程序的解释器晦涩难懂，容易被遗忘，充满了粗略的代码和漏洞。他们正在处理的惠普打印机也不例外，这里的`load`操作员是罪魁祸首。这个命令已经从 Type 2 规范中正式删除，可能是因为它代表了安全挑战，但是旧的解析器可能仍然支持它。`Load`只不过是一个`memcpy()`，由于解析器不能正确验证参数，这就允许任意的内存覆盖。研究人员选择覆盖另一个函数的函数指针，使他们能够跳转到他们能找到的任何代码小工具。通过明智地使用`longjmp()`函数，他们可以构造一个假堆栈，并直接跳转到该堆栈，从而导致任意代码执行。

有相当长的一节是关于他们如何逆向工程打印机的固件更新文件格式，以确定哪些型号仍然容易受到攻击。结果证明这是一个不必要的干扰，因为提取工具已经可用。让这成为我们所有人的一个教训，在花时间做别人可能已经做过并发表的工作之前使用搜索引擎。他们的研究结论是，38 种不同的惠普打印机容易受到攻击。更新是可用的，并且该漏洞的情况使得利用该漏洞的可能性更大。首先，这里写得很好，人们会认为感兴趣的人可以很容易地重现这个漏洞。第二，更新打印机固件通常是一件很麻烦的事情，因此未来几年，未打补丁的设备可能会无处不在。

## ms-officecmd

远程代码执行攻击有时非常困难，而且还有像 [ms-officecmd](https://positive.security/blog/ms-officecmd-rce) 这样的例子。这是操作系统对 URI 计划处理不当的又一个例子。[Fabian brunlein]和[Lukas Euler]在查看 Windows 10 中的 URI 处理程序时，发现了`ms-officecmd`方案。稍微研究一下就发现该方案需要 JSON 参数，这让他们很兴奋，因为它意味着复杂性。

一旦他们为 URI 方案找到了合适的 JSON 格式，他们就开始寻找滥用它的方法。他们发现的漏洞是发起带有`--gpu-launcher`旗帜的团队。这个标志允许指定一个任意的应用程序在启动时运行。使用 Chromium 衍生的浏览器，会出现一个弹出窗口，请求运行 URI 的许可。另一方面，传统 Edge 和 IE11 允许 Javascript `click()`命令触发链接并调用 URI，无需用户交互。微软看了一下错误报告，然后关闭了它，说，“不幸的是，你的报告似乎依赖于社会工程来完成，这不符合安全漏洞的定义。”值得庆幸的是，误解很快被澄清，但第一个补丁并没有解决问题，微软支付了漏洞价值的 10%。零点击漏洞已经修复，但仍然很容易将命令注入 URI 字段。

## 人工智能检测到奇怪的 TLS 证书

NCC Group 显然怀念过去的美好时光，那时 TLS 加密通常意味着流量是有效的。好吧，也许事情没那么简单。[不管怎样，[Margit Hazenbroek]指出，恶意软件有时会将其活动隐藏在 TLS](https://research.nccgroup.com/2021/12/02/encryption-does-not-equal-invisibility-detecting-anomalous-tls-certificates-with-the-half-space-trees-algorithm/) 中，但当您实际查看正在使用的 TLS 证书时，它看起来往往很奇怪。给出的 Ryuk 勒索软件的例子是一个很好的例子——列出的组织是“lol”。对于一个人来说，这很奇怪，但检查网络上使用的每个证书并不实际。

我们确实有一个工具，也许能够对古怪行为进行自动化测试，即机器学习。如果我们能够提供足够多的有效证书和可疑证书的好例子，人工智能模型也许能够实时标记可疑证书。使用半空间树，这是一种对给定例子的奇怪之处进行分类的聪明方法。NCC 集团已经在试验中取得了成功，现在已经在他们的 SECOPS 中心部署了这个想法。随着开源 ML 框架的出现，很少有人阻止我们自己重新实现这个想法，或者使用 AI 完成其他类似的任务。

## 更多的 NPM 恶意

罗顿 NPM 的软件包流似乎没有减少，因为又有 17 个被从仓库中删除。大多数都是我们以前见过的普通类型的域名抢注。然而，至少有一个正在使用依赖混淆攻击，恶意包的名称与私有包相同，希望目标的构建工具将获取恶意版本，而不是他们自己的私有包。同样有趣的是，这些恶意软件包中有几个试图窃取不和谐令牌，而许多只是抓取环境变量，希望找到秘密。

## 空气间隙

最后，如果你从阅读高复杂性恶意软件中得到乐趣，鉴于你正在阅读这篇专栏文章，你可能会这样做，那么你会欣赏 ESET 的 [15 年跳越空气间隙的总结](https://www.welivesecurity.com/2021/12/01/jumping-air-gap-15-years-nation-state-effort/)。没有你可能从 APT 团体中期待的[假设魔法](https://hackaday.com/blog/?s=air-gap)。所有在野外发现的东西都使用低级的 USB 密钥进行跳跃。虽然 Stuxnet 无疑是最著名的，但它并不是第一个被部署的恶意软件程序。概述很棒，它提醒我们，最简单的设备 USB 驱动器也可以如此有效。