# 黑我的房子:向互联网开放树莓派，但不是全世界

> 原文：<https://hackaday.com/2018/11/14/hack-my-house-opening-raspberry-pi-to-the-internet-but-not-the-whole-world/>

如果你一直关注我们的系列，你会知道我们已经建立了一个树莓 pi 网络，PXE 从中央服务器启动，然后 T2 使用 Zoneminder 运行 IP 摄像头网络。现在，一些有用的服务正在我们的智能房屋中运行，我们如何在离家时访问这些服务，以及我们如何防止世界其他地方监视我们的摄像头？

在我们讨论 VPN 和端口转发之前，还有一个更基本的问题:您信任您的设备吗？那些廉价相机上的固件到底在做什么？您可以使用 Wireshark 和带有端口镜像的智能交换机来审计摄像头的流量。您需要检查多少流量才能确信摄像头不会将您的数据发送到其他地方？

谢天谢地，有更好的方法。像 Zoneminder 这样的监控软件的一个主要特点是它聚集了来自摄像头的反馈。这个过程还具有代理视频馈送的效果:我们不是为了查看而直接连接到摄像机，而是连接到监控软件。如果你不完全信任那些摄像头，那就不要给它们上网。您可以使摄像机成为一个物理上独立的网络，只连接到监控机器，或者只手动设置它们的 IP 地址，而不填写默认路由或 DNS。无论你用哪种方式设置，目标都是一样的:让你的监控软件与摄像头对话，但不要让摄像头与外界对话。

编辑:正如评论中所指出的，保留默认路由远不如独立网络有效。一个真正恶意的硬件设备很容易探测到网关。

这个想法不仅适用于照相机。任何不需要互联网接入的设备都可以通过这种方式隔离。虽然这可能被认为是偏执狂，但我认为这是简单的良好做法。休息之后，请和我一起讨论端口转发与 VPN。

## 懒人:端口转发

远程访问问题有两大类解决方案，第一类是端口转发。简单地将分配的端口从路由器转发到服务器当然是最简单的，但也是最不安全的。暴露在互联网上的端口 80 (HTTP)或 22 (SSH)的日志很难仔细检查。在你认为你永远不会在开放港口的汪洋大海中被发现之前，我向你介绍罗伯特·格雷厄姆和马斯坎。能够在几分钟内扫描给定端口的每个 IP 地址，您不会隐藏 web 服务器太久。

像[lib ssh 漏洞](http://hackaday.com/2018/10/16/libssh-vuln-you-dont-need-to-see-my-authentication/)这样的故事不断提醒人们将服务向互联网开放的危险性。如果你选择走这条路，你必须保持在安全更新的顶部，使用非常强的密码，并希望最好的。Fail2ban、虚拟化和良好的备份都是抵御公共互联网冲击的宝贵工具。简单地说，我不建议家庭用户使用这种方法。

一种替代方法是简单地使用不同的外部端口号。HTTP 服务器的端口 8080 是一个流行的选择，这使得它在试图隐藏服务时是一个糟糕的选择。使用 10，000 到 65，000 之间的随机端口是一种策略，称为“通过模糊实现安全性”。知道你 IP 地址的心怀怨恨的人会找到它。但是随机扫描每一个可能的 IP 地址的每一个可能的端口，这就像大海捞针一样困难。

属于端口转发类别的另一种技术是端口敲门。发送到预定端口列表的一系列 TCP SYN 数据包(初始连接尝试)会向侦听守护程序发送信号，然后允许您通过防火墙进行连接。虽然聪明，端口敲门是受重放攻击和一些其他问题。如果 port knocking 的聪明吸引了你，那么这个想法还有一个更现代的形式 [Fwknop](http://www.cipherdyne.org/fwknop/) (完全公开，我在这个项目上做了一些开发)。

## 为了省心:VPN

保护远程访问的另一种方法是 VPN。虚拟专用网被描述为在互联网上延伸一条长得离谱的以太网电缆。端点之间的流量是加密的，由于 VPN 创建了一个虚拟网络适配器，远程用户可以像物理连接到网络一样访问网络。

OpenVPN 是开源 VPN 领域久经考验的竞争者，并且有着良好的记录。它基于 TLS，可以在 TCP 或 UDP 上运行，应用广泛。对 Android、iPhone、Windows、MacOS 和 Linux 都有很好的支持。完成配置可能是一个挑战，但是一旦它启动并运行，OpenVPN 就是一个很好的解决方案。

Wireguard 是一个更新的项目，目标是比 OpenVPN 更简单。我选择了 Wireguard，它有很好的 Android 和 Linux 支持。事实上，Wireguard 已经朝着被正式包含在 Linux 内核中的方向稳步前进。通过 MacPorts 和 Homebrew 已经有 macOS 支持，他们的 iOS app [刚刚进入 beta](http://lists.zx2c4.com/pipermail/wireguard/2018-November/003526.html) 。Wireguard 使用更现代的加密技术，旨在比其他产品更快、更安全。

OpenWrt 支持这两种 VPN，将 VPN 托管在路由器上也有好处。当在本地网络的另一台机器上托管 VPN 时，我有两条建议，因为这两个问题会反复困扰我。第一种是在 VPN 机器上启用 IPv4 转发。第二，网络上的其它设备必须配置到达 VPN 网络的路由，这样流量才能双向流动。如果没有静态路由，发往 VPN 的数据包将被发送到默认路由器，而不是 VPN 服务器。

## 无声无息地运行

最后一个考虑是你是否希望你的 IP 地址完全无声。称为“黑洞”，或“隐形模式”，这是当您的 IP 地址不响应 pings，而不是响应 ICMP 错误数据包的连接尝试，这些传入的数据包被无声地丢弃。这里的目标是，对于网络扫描，您的 IP 地址似乎是未分配的，没有监听流量。

在 UDP 模式下，OpenVPN 和 Wireguard 都支持这种安静操作方式。就 OpenVPN 而言，基于哈希的消息认证码(HMAC)允许传入的 UDP 数据包在没有使用有效的 HMAC 签名时被快速丢弃。Wireguard 是以这种无线电静默为设计目标编写的，并且不需要任何额外的配置来启用它。

## 为什么值得思考

这显然是一个概述，还有许多聪明的想法我们还没有触及。当我不想建立一个完整的 VPN 时，我经常求助于结合了 SSH 隧道的 Fwknop。通过 Strongswan 项目的 IPSec 仍然是一个有效的解决方案，还有许多其他的解决方案。

最重要的是，不要轻率地让整个世界尝试登录您的房子。黑房子的部分吸引力是能够在度假时监控事情，但你不想总是感觉有人在监视你！

接下来，我们将看一个联网的车库门开启器，并讨论绕过供应商的专有协议的方法，也许是如何对其进行逆向工程的初级读本。