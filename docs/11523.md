# 远程蜂窝接入基础:看门狗

> 原文:[https://hack aday . com/2021/10/14/basics-of-remote-cellular-access-watchdogs/](https://hackaday.com/2021/10/14/basics-of-remote-cellular-access-watchdogs/)

当谈到远程机器时，有时我们指的是*真正的*远程，超出了可以提供互联网的有线网络的范围。在这种情况下，远程蜂窝接入通常是一个不错的选择。到目前为止，我们已经探索了通过蜂窝连接远程控制机器所需的[硬件](https://hackaday.com/2020/12/18/basics-of-remote-cellular-access-choosing-a-modem/)和[软件](https://hackaday.com/2021/01/14/basics-of-remote-cellular-access-connecting-via-vpn/)方面。

然而，事情可能并且确实会出错。当远程机器离线时，让现场的人重新启动它会非常困难和昂贵。在这些情况下，你需要的是某种方式让事情恢复正常，最好是自动恢复。你要找的是看门狗定时器！

## 看门狗

看门狗定时器的概念很简单。当连接到系统并启用时，看门狗定时器从预设时间开始倒计时。然后，嵌入式系统或计算机负责定期向看门狗发送“踢”信号。这将使看门狗复位到其最大时间值，并再次开始倒计时。如果在看门狗定时器到达零之前没有收到“kick ”,看门狗将重新启动系统。

![](../Images/da443e3ca4b761e276be0b107ae5e9b0.png)

A simple watchdog timer.

获得正确的看门狗间隔非常重要。设置太短，负载过重的系统可能无法及时响应，并导致不必要的重新启动。如果设置得太长，那么在看门狗重新启动并运行之前，系统可能会停机很长一段时间。需要仔细分析系统及其适当的行为，以便对此进行适当的调整。

这是一种处理远程机器崩溃、内核崩溃和系统挂起的便捷方式。当机器卡住时，它可以自动重启，而不必派技术人员去按复位按钮。看门狗定时器在一些应用中至关重要，在这些应用中，发送一个人可能要花费数千美元，甚至是不可能的，例如在卫星和其他空间应用中。

![](../Images/7649e604dcef91b1e97bfa46bff9ebed.png)

A multi-stage watchdog timer, which takes corrective measures in turn before going for a full power cycle of the target machine. If the system manages to fire off a kick signal after stage 1 or stage 2 has fired, the system resets to normal operation.

更复杂的设计也是可能的。多级看门狗定时器包括几个串联的定时器。在这种设计中，当第一个看门狗在没有收到“踢”之后超时时，它采取纠正措施并启动第二个定时器。如果这不能纠正这种情况，最终第二个计时器将超时，启动进一步的纠正操作，等等，直到所有阶段都启动。这对于更复杂的应用程序很有用。第一阶段定时器可以向服务器发起简单的进程终止命令，第二阶段定时器可以向操作系统发起软件关闭命令，而第三阶段定时器可以执行带有电源循环的完全硬复位。

## 但是，我如何实现它呢？

![](../Images/6719d38a90ef29ea043ce5efd435b343.png)

Watchdog timers are critical in space systems like the Curiosity Rover.

在给定的系统上实现看门狗高度依赖于所讨论的应用程序。对特定看门狗设计的详尽分析超出了本文的范围。相反，我们将看看几个陷阱，并概述几个不同的案例，突出了看门狗设计的不同范围。

### 陷阱

请注意，这些情况都是指适当的硬件看门狗。理想情况下，为了获得最大的健壮性，看门狗应该是一个完全独立的硬件，能够重新启动感兴趣的主系统。一些微控制器和片上系统确实包含内部看门狗，以不同的独立级别运行，这些也是可用的。然而，它们通常必须由主代码循环适当地触发。使用中断来触发看门狗可能充满危险。主循环可能会崩溃，但只要中断仍然触发，看门狗就永远不会重置系统。

同样需要注意的是，“软件看门狗”通常不是。例如，创建一个进程来观察计算机系统上的其他进程会很有帮助。它可以捕捉各种小故障和问题，并在需要时重新启动其他流程。然而，如果另一个进程使整个机器崩溃，或者产生一个低级别的问题，比如内核崩溃，软件看门狗将无能为力。一般来说，一个合适的看门狗应该在很大程度上独立于它所监控的系统。

### 案例研究 1:自制坦克炮

假设您正在远离家乡的地方部署一个家酿树莓 Pi 项目，以监控几个水箱中的水位。这不是什么关键任务，如果系统崩溃也不会有生命危险。然而，该系统是由太阳能充电的电池供电的，并且如果当电量水平变低时出现问题或者如果其他原因导致崩溃，您希望避免不得不开车重新启动系统。

在这种情况下，一个简单的解决方案可以消除很多令人头疼的问题，而不会增加很多复杂性。像 Arduino Uno 这样简单的东西可以很容易地安装来实现看门狗。Raspberry Pi 可以配置为向 Arduino 发送 GPIO 脉冲或串行消息，以表明它仍在正常运行。如果在设定的时间内没有收到信号，Arduino 可以通过简单地用继电器切断电源来重新启动 Raspberry Pi。如果系统不关键，这段时间可能是几分钟、几小时，甚至更长。诀窍是不要让它太短，否则如果系统暂时负载过重，尽管系统实际上没有崩溃，看门狗可能会超时。

在系统中安装 Arduino 还能带来更多好处。它可以向 Raspberry Pi 发送命令，以便在电池电压开始变低的情况下安全关闭。此外，它可以命令每天或每周定期软重启 Raspberry Pi，以防止进程中任何潜在的故障，这些故障可能会因长时间运行而崩溃。

我已经在野外的移动机器人上实现了类似的系统，它们的工作效果惊人的好。然而，确保看门狗正确运行是很重要的。例如，Raspberry Pi 上的一个主要进程可能会被卡住，但不会导致整个系统停机。如果负责向 Arduino 发送信号的看门狗服务进程能够独立运行，尽管主进程不再工作，系统仍将保持通电。解决方法是让看门狗服务在向外部看门狗发送 kick 信号之前检查其他进程是否正常运行。如果您正在编写自己的代码，这很容易做到！然而，检查其他程序是否正常运行会更加困难。在这种情况下，定期的先发制人的软重启可能是一种偷偷摸摸的解决方法。对于自制的东西，它通常是足够好的。

### 案例研究 2:远程泵控制器

当机器被允许自己采取行动，而不仅仅是报告数据时，事情会变得更加复杂。例如，想象一个负责控制水泵从大坝或其他水源向水箱注水的系统。该系统可以通过蜂窝数据链路进行监控和手动控制，但也可以独立运行，昼夜不停。

在这种情况下，可能需要更加严格来避免灾难。如果系统在水泵启动时崩溃，大坝可能会被清空，导致水泵干涸，造成昂贵的损失。或者，储罐可能会溢出，或者发生洪水。根据规模的不同，这可能会导致棚子里一片狼藉，或者毁坏庄稼、房屋和牲畜。

因此，在这些情况下，必须实施更严格的看门狗。例如，在泵控制器停止向看门狗发送 kick 信号的情况下，简单地重新启动泵控制器可能是不够的。在这种情况下，看门狗可以被配置为首先将泵切换到故障安全关闭状态，以最小化损坏的可能性。然后，系统可以重新启动，当重新联机时，远程操作员通知由于故障必须手动触发重新启动。这避免了系统简单地重新启动，并在出现问题时立即再次失败。

在这些情况下，特别是在昂贵的设备甚至人的生命可能处于危险之中的情况下，简单的 Arduino 可能不会充当合适的可靠看门狗。在某些情况下，可能需要多个冗余监视器，以便在出现故障时提供更大的机会来停止系统。在最高级别，将需要代码审查和风险评估，以及全面的专门认证的硬件。但是，如果你正在为一个市级大坝或其他安全关键设施开发一个监督系统，你可能不会考虑如何去做。如果你是，请联系你的主管或其他官员，告诉他们你需要帮助。

## 摘要

本文的目的是解释看门狗的基本概念，以及为什么它们对远程系统有用。希望这里介绍的思想足以帮助您实现看门狗定时器，以提高您自己项目的正常运行时间和可维护性。毕竟，没有什么比在 Hackerspace 向每个人展示您坚固可靠的远程项目更酷的了。没有什么比您的现场演示失败更糟糕的了，因为您无法重启失败的远程机器。因此，让你的看门狗运行起来，展示你是一个多么伟大的黑客！