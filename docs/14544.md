# 建立自己的共识

> 原文:[https://hack aday . com/2022/11/30/building-your-own-consensus/](https://hackaday.com/2022/11/30/building-your-own-consensus/)

数十亿台计算机每天都在相互交流，它们是如何做出决定的？即使在数据库或服务器部署中，组成数据库的不同计算机如何决定提交了哪些值？他们是如何在时间上达成一致的？他们是如何达成共识的？

但是首先，在计算机的环境中，一致的概念是什么？简而言之，所有相关的代理人都同意一个单一的价值。然而，协议中设计了对不同意、不正确或出错代理的允许。每个正确的代理人必须回答，所有正确的代理人必须有相同的答案。这对于数据中心或网状网络尤其重要。如果网络变得分区，一些节点离线，或者软件奇怪地崩溃，发送奇怪的乱码数据，会发生什么？最常见的共识算法之一是 Raft。

### 大量

《数据的秘密生活》有一个很棒的动画演示，展示了数据如何在代理之间的 Raft 算法中流动。Raft GitHub 页面[也有有用的图表](https://raft.github.io/)。Raft 有可证明的保证，由当选的领导人提供容错。重要的是，这位选举出来的领袖确实导致了拜占庭失败的弱点，但我们稍后会谈到这一点。像蟑螂数据库、Splunk 和 MongoDB 这样的数据库经常使用 Raft，它是专门为允许代理同意一组状态转换而调优的，比如对数据库的事务。总结一下 Raft 算法，分为两个部分:首领选举和日志复制。

想象一下，一组服务器相互通信，一个客户端生成消息。这些消息可以是任何内容，比如“将寄存器 Y 设置为 6”或“删除 id = 1230231 的行”。当服务器第一次出现时，它们处于追随者状态，希望通过心跳听到领导者的声音。如果他们在 150 到 300 毫秒内没有收到心跳，他们会试图成为候选人。然后，服务器对候选人进行投票，在分裂投票的情况下，选举期结束，循环再次开始。超时是随机的，以试图防止分裂投票。

客户端向当前领导者发送消息，然后领导者将消息复制给所有追随者。一旦它收到大多数追随者的回复，该消息就被认为是提交的。这些消息被附加到日志中，以便在所有服务器上保持一致。如果领导者失败，将使用新选出的领导者的日志，并删除不一致的条目。因为任何跟随者都必须拥有最新的提交日志才能被考虑用于选举，所以它确保提交给大多数人的数据不会丢失。

### 拜占庭式的失败

[![](../Images/6e03e77f7f5db801252d27c46bff98db.png)](https://hackaday.com/wp-content/uploads/2022/11/Byzantine_Generals.png)

“[Byzantine Generals](https://commons.wikimedia.org/wiki/File:Byzantine_Generals.png)” by Lord Belbury: How can you tell if everyone got the message?

如前所述，Raft/Paxos 针对服务器故障提供保护，而不是针对拜占庭故障。名字来源于著名的拜占庭将军问题，这里有些将军不靠谱。他们说一套做一套。Raft 假设当系统崩溃时，它会失败并重新启动。这不是硬件意义上的情况，因为设备可能会继续产生不一致的数据，不正确地操作，甚至被敌对的实体接管。

然而，许多实时系统，如飞机或宇宙飞船上的系统，必须牢记拜占庭故障。一个组件可能产生错误的数据，系统的其余部分必须解决这个问题。这可以通过额外的消息来验证其他服务器的行为，签署数据，或者甚至完全摆脱领导者的想法来实现。

### 锁步协议

如果你玩过一款即时战略游戏，你可能会想这个游戏怎么能在几十个玩家之间保持一致，而他们的连接速度又慢得令人难以置信。不幸的是，帝国时代的网络是在 1996 年开发的，当时 28.8 调制解调器是相对标准的。所以，当你每秒钟有几个比特可以用来应对网络延迟波动的时候，你怎么能把屏幕上每个物体的位置和更新串起来呢？答案是你没有。

有一篇精彩的[文章是关于让 1500 名弓箭手实时奔跑的](https://www.gamedeveloper.com/programming/1500-archers-on-a-28-8-network-programming-in-age-of-empires-and-beyond)，作者是《帝国时代》的作者(除了其他事情之外)。答案只是发送玩家的动作而不是游戏中每个物体的状态。每个游戏运行完全相同的模拟，每个玩家的命令都在每个玩家的计算机上模拟。在许多方面，这就像 Raft 协议一样:消息被传递并附加到一个只读日志中，并且该日志必须在所有计算机上保持一致。但是和 Raft 不一样，没有领导，每个服务器也是客户端。有一个主机，但没有一个真正的权威对游戏的状态。

所有客户都有一个一致的单调匝数。每个命令计划运行两次。这允许在游戏模拟时发送、确认和处理命令。这确实意味着模拟只能以最慢的机器运行，并且有一个速度控制器来改变一轮的长度以保持游戏的可玩性。通过将渲染时间与回合时间分开，即使回合率相对较低，游戏对玩家来说仍然非常流畅。

因为每个客户端都运行相同的模拟，所以很难作弊(又是拜占庭问题)。任何发送混乱或无意义信息的客户端都将被取消同步并被踢出游戏。然而，正如您可能会想的那样，至少可以说，让一个具有随机性和概率的模拟在几十台具有不同处理器甚至可能不同架构的机器上保持一致是一个挑战。

### 秘密党员

在 Hackaday 这里，我们倾向于将[集中在比特币](https://hackaday.com/2021/04/01/mining-bitcoin-on-the-nintendo-game-boy/)的实际挖掘方面，但是网络如何就下一个散列达成一致呢？这才是工作证明的真正力量。这是一个大规模的分布式共识算法，可以容纳很大比例的坏演员。我们就不细说了(也许改天再写文章)。归根结底，这是区块链唯一的力量，以及随之而来的所有宣传。它只是一个条目的日志，我们都可以以分散的方式达成一致。 [Chia 是另一种加密货币](https://hackaday.com/2021/07/07/whats-chia-and-why-is-it-eating-all-the-hard-drives/)，其工作原理类似，但使用股权证明而不是工作证明，但其核心概念相同。

### 共识无处不在

从飞机到网络服务到加密货币，共识无处不在。因此，有数百种共识算法，每种算法都有不同的权衡和性能特征。也许下一次你在实施一个网格规模的 IOT 项目，其中有许多节点需要在共享值上达成一致，你可以在这里得到一些想法。