# 本周安全:使用 Emacs，使 Windows 服务器崩溃，和一次加密货币抢劫

> 原文:[https://hack aday . com/2019/06/14/this-week-in-security-use-emacs-crash-a-windows-server-and-a-cryptocurrency-heist/](https://hackaday.com/2019/06/14/this-week-in-security-use-emacs-crash-a-windows-server-and-a-cryptocurrency-heist/)

看起来 Al 是对的，我们都应该使用 Emacs。6 月 4 日，[阿明·拉兹姆茹]宣布了 Vim 中的一个缺陷，该缺陷允许恶意文本文件触发任意代码执行。我们并不是每天都会遇到恶意的文本文件，概念验证使用了一种巧妙的技术——转义序列隐藏了实际的负载。用 cat 打印文件会返回“这里什么都没有”Cat 有一个“-v”标志，这个标志泄露了我们恶意文本文件的秘密。为简单起见，我们将查看不包含控制字符的 PoC。漏洞是 [Vim 的 modeline 函数](https://vim.fandom.com/wiki/Modeline_magic)。这是在文本文件中包含编辑器选项的能力。如果一个文本文件只能处理 80 个字符的列，那么 modeline 可以设置“textwidth=80”。Modeline 已经利用沙盒来防止最明显的漏洞，但[阿明]意识到“:来源！”命令可以在沙箱之外运行文件的内容。":来源！% "运行当前文件(恶意文本文件)的内容。

```
:!uname -a||" vi:fen:fdm=expr:fde=assert_fails("source\!\ \%"):fdl=0:fdt="
```

一次分解一个元素，然后“:！”是在 shell 中运行某些内容的正常模式命令，所以该行的其余部分就是要运行的内容。“uname -a”是任意命令，在本例中是良性的。接下来是 OR 运算符“||”，它首先计算第一项，如果第一项返回 false，则只计算运算符后面的内容。在这种情况下，就 bash 而言，这是一种让有效负载运行的简单方法，即使该行的其余部分是垃圾。" vi:"通知 Vim 我们有一个 modeline 字符串。“:fen”启用折叠，而“:fdm=expr”将折叠方法设置为使用表达式。该特性通常用于自动隐藏匹配正则表达式的行。":fde= "是设置折叠表达式的命令。这是一个漏洞，折叠表达式可以是像“execute()”或“assert_fails()”这样的函数，它允许调用:source！命令。这将执行弹出沙箱，并开始执行 vim 中的文本文件，就像用户从键盘输入文本文件一样。

[阿明]建议完全禁用 modelines，并提到 Debian 默认会这么做。我检查了我的 Fedora 桌面，虽然我已经将 Vim 更新到补丁版本，但我惊讶地看到 modelines 仍然启用。我很快打开了“/etc/virc”并在那个文件的末尾添加了“set nomodeline”，我建议你也这样做。

### 很久以前的电子邮件错误

Exim 电子邮件服务器有一个远程命令执行漏洞，利用需要一周的真实时间[。要运行的代码嵌入在 send-to 电子邮件地址中:“run{kcalc}@localhost”，某个代码路径使用“expand_string()”处理该地址，该地址包含一个运行命令的函数，非常有用。Qualys 的研究人员在试图远程利用这个问题时遇到了一个问题:默认情况下，Exim 会检查收到的电子邮件的有效目的地地址。“run{}”显然不是一个有效的用户名，因此消息永远不会与易受攻击的代码交互。退一步说，解决这个问题的办法很聪明。](https://seclists.org/fulldisclosure/2019/Jun/16)

默认情况下，当电子邮件服务器收到无法成功发送的邮件时，会生成一封退回邮件，通知发件人邮件发送失败。这种退回邮件使用发件人报告的电子邮件地址，使得攻击者能够在该地址中插入命令。这解决了一个问题，但产生了另一个问题。并非所有消息都会触发易受攻击代码的执行，因为攻击者依赖于反弹消息来触发漏洞，所以他无法再操纵消息的故障模式。完整的攻击是从“run{…}@attackerdomain.com”向易受攻击的 Exim 服务器发送电子邮件。当该服务器试图连接到攻击者的 MX 服务器以传递 bounceback 消息时，攻击者通过每四分钟仅发送一个新字节来强制连接打开 7 天。一旦 7 天过去了，连接就会因永久性的传递失败而终止。这种特定的故障状态会触发易受攻击的代码，运行指定的命令。至少有一个报告说这个漏洞正在被广泛利用，所以如果你正在运行 Exim，安装补丁吧！

披露线程包括两个非常老的 Sendmail 故事，即 [WIZ](https://seclists.org/bugtraq/1995/Feb/56) 和 [DEBUG](http://www.cheswick.com/ches/papers/berferd.pdf) 漏洞。两者都是有趣的读物，并提醒人们计算机安全的简单日子。

### 你的 90 天到了！

谷歌的 Project Zero 对争议并不陌生，本周也不例外。周二，[塔维斯·奥曼迪]宣布了 Windows 加密程序中的一个新的拒绝服务漏洞。你可能认识上周的[的【Tavis】。按照这种速度，我们需要在几周内重新命名该列。](https://hackaday.com/2019/06/07/this-week-in-security-nvidia-ransomware-retirement-and-a-toctou-bug-in-docker/)

当处理特定的 X.509 证书时，这种特殊的错误会导致死锁。到目前为止，这个 bug 还没有命令执行的路径，但是不难想象攻击者通过在电子邮件或其他渠道中发送这个特定的证书来使 Windows 服务器离线。

当微软被告知这个问题时，他们要求额外的一天，以便在 11 日星期二发布补丁。尽管这在技术上是第 91 天，Project Zero 团队还是同意了。11 日，微软选择不发布补丁，漏洞如期公布。虽然有些人已经谴责了这个漏洞的发布，但我只能说微软被给予了足够多的时间来推出修复程序，Project Zero 也做了他们同意做的事情。

### 入侵加密货币钱包来拯救它们

又是一天，又是一次供应链攻击。Javascript 库`electron-native-notify`已更新，包含恶意代码。这个特殊的库被用于由 Komodo 开发的 Agama 加密货币钱包。国家预防机制安全团队[在国家预防机制官方博客上给出了他们的观点](http://blog.npmjs.org/post/185397814280/plot-to-steal-cryptocurrency-foiled-by-the-npm)。他们发现了恶意代码，并通知了使用该库的项目，包括 Komodo。这段代码将钱包信息和秘密上传到攻击者的服务器上，然后攻击者利用这些信息从易受攻击的钱包中榨干钱财。

意想不到的是，用于存储被盗信息的服务器可以公开访问，科莫多安全团队也知道这件事。这是一个伦理上的两难问题。他们正看着一场对用户的主动攻击，但唯一直接的解决方案在法律上和道德上都是有问题的。科莫多决定咬紧牙关投入行动。是的，他们黑了自己的客户，利用窃取的信息将加密货币从现在脆弱的数字钱包中转移出来。科莫多仍在努力恢复失踪的资金给他们的用户。他们必须在如此短的时间内做出决定，这一定是非常困难的，这提醒了我们安全工作中偶尔存在的灰色地带。

看来，将恶意代码推入问题库中的开发人员瞄准 Agama wallet 已经有一段时间了，为 Agama 项目做出了真正有用的代码贡献。我们过去见过这种类型的攻击——首先想到的就是事件流。在这两种情况下，一个开发人员似乎是一个有用的贡献者，并很快被授予了太多的项目访问权限，结果只是在消失之前将恶意代码推入项目。我相信这不会是最后一次尝试这种方法——当它发生时，我们一定会告诉你。敬请期待！