# 本周在安全:使用后免费为假人，无线破解，和 PHP-FPM

> 原文:[https://hack aday . com/2021/10/29/this-week-in-security use-after-free-for-dummies-wifi-cracking-and-PHP-fpm/](https://hackaday.com/2021/10/29/this-week-in-securityuse-after-free-for-dummies-wifi-cracking-and-php-fpm/)

在一篇精彩的文章中，【唐崇荣】为我们带来了他的“[假人用后免费”](https://github.com/stong/how-to-exploit-a-double-free)。这是一个不应该存在的漏洞的令人惊讶的故事，也是如何完成捕获旗帜挑战的演练。易受攻击的二进制文件运行在 Raspberry Pi 上，这被证明是非常重要的。这是一个多线程应用程序，通过多线程可读的整数对，使用无锁数据共享。这些 int 是使用`volatile`关键字声明的，这是一种告诉编译器不要过度优化的有用方法，因为这个值可能会被另一个线程更改。

在 x86 机器上，这种方法可以完美地工作，因为所有的无序执行特性都保证是全局透明的。换句话说，即使线程一可以通过提前修改共享内存来加快执行速度，CPU 也会按照正确的顺序保持共享内存的变化。当共享内存控制并发访问时，按照您期望的方式进行排序非常重要。令我惊讶的是，ARM 平台不提供这种全局内存排序。虽然乱序执行对于做出改变的线程来说是透明的，但是其他线程和进程可能会观察到那些乱序的动作。一个例子可能有所帮助:

```

volatile int value;
volatile int ready;

// Thread 1
value = 123; // (1)
ready = 1; // (2)

// Thread 2
while (!ready); // (3)
print(value); // (4)

```

这是[斯蒂芬]的一个例子。如果将它设置为在两个线程中运行，那么在 x86 机器上，可以保证(4)总是打印 123。在手臂上，没有这样的保证。您很可能有一个未初始化的值。这是一个竞赛条件。现在你可能看着这个，像我一样想知道，怎么会有人为 ARM 芯片编程呢？首先，尽管内存重新排序是一件事，但 ARM 保证了同一线程内的一致性。这个怪癖只影响多线程编程。第二，多线程编程的库提供了[语义来标记需要在线程间正确排序的内存访问](https://preshing.com/20120913/acquire-and-release-semantics/)。

正在讨论的实际可利用的二进制文件对进程间缓冲区使用循环队列，并跟踪头尾位置，以确定缓冲区有多满。一个进程放入数据，第二个进程读出数据。该漏洞是，当缓冲区完全填满时，内存操作重新排序会导致争用情况。这个环形缓冲区被指针填满，当攻击者赢得比赛时，同一个指针被使用两次。本质上，程序现在有两个对同一个对象的引用。没有任何进一步的技巧，当第二个引用被释放时，这会导致双自由错误。

我们可以用什么样的技巧来利用这个漏洞？首先，要知道我们拥有的是对一个对象的两个引用。该对象包含指向另一个字符串的指针，其长度完全由用户提供的数据控制。我们可以触发其中一个引用的释放，这将导致对象被释放，但我们仍然有另一个引用，它现在指向未初始化的内存。为了把它变成一个任意的读数，使用了一个非常聪明的技巧。在释放我们的对象之前，我们分配另一个对象，并存储一个长字符串。然后我们释放我们有双重引用的对象，最后释放有长字符串的对象。最后，我们再分配一个对象，但是我们存储的字符串看起来像一个有效的对象。内存按照后进先出的顺序被重新分配，所以字符串存储在我们仍然引用的回收内存中。程序希望对象包含一个指向字符串的指针，所以我们的假对象可以指向任意内存，然后我们可以读取它。

最后一个技巧是任意写入，这更难做到。这里的技巧实际上是执行双自由，但操纵系统，使其不会导致 segfault。我们可以使用上面的技巧将任意数据写入一个空闲的内存位置。因为该位置已经两次出现在空闲列表中，系统仍然认为它是空闲的，尽管它也在使用中。Linux 内存管理器使用一个聪明的技巧来管理回收的内存块，在每个块中存储一个指向下一个回收位置的指针。在该空闲块中写入您想要覆盖的位置，然后分配另一个块。系统现在认为您的任意位置是下一个要使用的空闲内存位置。下一个分配是你任意写。这篇文章有更多的细节，以及剥削链的其余部分，所以请务必阅读全文。

## 无线网络有多安全？

CyberArk 的[Ido Hoorvitch]有一些疫情诱导的时间，他选择收集特拉维夫周围 5000 个密码保护的 WiFi 网络的数据包捕获。在过去，你必须捕捉 4 次握手才有机会破解 WPA 加密。2018 年[发现了一种新技术](https://hashcat.net/forum/thread-7717.html)，尝试破解密钥只需一个认证响应，无需主动用户。这里的神奇字符串是 PMKID，它是 WPA 密码和其他网络细节的阿沙-1 散列，首先通过一个密钥派生函数运行。

流行的工具 Hashcat 可以利用 GPU 来加速 PMKID 的破解。毕竟，SHA-1 散列是 GPU 特别擅长的事情之一。8 个 Quadros 每秒处理近 700 万次哈希计算。试图破解 WPA 密钥的问题是，虽然它们必须至少有 8 个字符长，但它们可以更长，从而形成巨大的搜索空间。[Ido]使用的第一个技巧是利用一个常见的密码来源，一个手机号码。在特拉维夫，这意味着密码是 05 后加 8 位数字。这是一个可搜索的关键空间，在 5000 个搜索过的网络中，近一半被这种方法破解了。下一步是将 Hashcat 指向一个字典文件，自动尝试已知的密码。在字典攻击和基于约束的方法(如单元号格式)之间，70%的目标网络被破解。外卖？使用不容易被猜到的长密码，并且不容易成为受限搜索的一部分。

## 免费概念验证后使用 Google

[CVE-2021-30573](https://securityforeveryone.com/blog/google-chrome-zero-day-vulnerability-cve-2021-30573)在今年 6 月由人人安全团队报告，现在已经发布了概念验证。Chrome/Chromium 92 中修复了此漏洞。触发代码有点简单，但却是非常畸形的 HTML。试图通过查看来解析这段代码，我立刻称之为“被诅咒的”HTML，所以难怪 Chrome 也遇到了问题。

```

<select class="form-control">
<option style="font-size: 1rem;" value="
<"">
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA(abbreviated)
</>">a
</option>
</select>

```

## PHP Worker 到 Root

ambonics Security 发现 PHP-FPM 中的一个漏洞，允许从对 PHP 工作人员的控制直接跳转到系统根。虽然这是一个严重的问题，但这不是远程代码执行漏洞。首先需要使用一些其他技术来接管 PHP 工作线程。这意味着攻击者需要能够运行 PHP 代码，然后找到逃离 PHP“沙箱”的方法虽然不是微不足道的，但有一些技术和缺陷使这成为可能。

问题是进程间的通信机制是共享的映射内存，而且有太多的数据结构可供单个工作人员使用。工作人员可以修改主数据结构，使顶层进程写入任意内存位置。虽然位置可能是任意的，但在此漏洞中，实际的数据写入是极其有限的。事实上，它归结为两个写原语:Set-0-to-1 和 clear-1168-bytes。这可能看起来不多，但有许多标志可以通过设置值为 1 来切换，其余的利用大量使用该技术。真正的技巧是生成任意的错误消息，然后使用 0 到 1 原语来破坏这些消息的数据结构。

自 PHP 5.3.7 以来，这个漏洞已经存在很长时间了。在 8.0.12，7.4.25，7.3.32 中修复。这里的最后一个小问题是 PHP 7.3 仍然支持安全，但这被认为是一个入侵性的变化，PHP 维护者最初选择不将补丁推送到这个旧版本。在错误讨论的一些来回[之后，做出了正确的决定，7.3.32 已经发布了修正。](https://bugs.php.net/bug.php?id=81026)

## 野外的 Gitlab

HN 安全部门有一个客户报告了一些可疑的东西，结果是在野外使用的[CVE-2021-22205](https://security.humanativaspa.it/gitlab-ce-cve-2021-22205-in-the-wild/)。这个 bug 是 ExifTool 中的一个问题，在这里[一个 DjVu 文件可以执行任意 perl 代码](https://hackerone.com/reports/1154542)。该 RCE 被滥用来让新用户管理受攻击的系统。如果你运行 Gitlab，确保你是最新的。今年 4 月 14 日发布了 13.10.3、13.9.6 和 13.8.8 版，并进行了修复。看起来 14 号。*版本从不容易受到攻击，因为 14.0 版是在此修复后发布的。Hackerone 和整个 bug bounty 社区都有它的问题，但是[这个](https://hackerone.com/reports/1154542)的披露线程是一个程序正确运行的例子。