# 来自系统管理员的故事:转储到 Grub 命令行

> 原文：<https://hackaday.com/2019/11/25/tales-from-the-sysadmin-dumped-into-the-grub-command-line/>

今天我有一个神秘、恐怖和希望的故事。新内核和包的诱惑太大了，无法抗拒，所以我发现自己升级到了 Fedora 30。所有的软件包都已下载，剩下的就是让 DNF 重启机器并安装所有的新软件包。我开始了这个过程，然后漫步出去找一杯咖啡:黑色，比这一行工作在灵魂上留下的污点还要黑。过了足够长的时间后，我回来了，期待着新升级的桌面发出温暖的光。相反，迎接我的是一条`grub`命令行的严酷黑暗。有些不对劲，而且很糟糕。

(顺便说一句，我在两台不同的机器上有过这样的经历，源于两个不同的根本问题。一个是任性的设置，另一个是不寻常的权限问题。)

初出茅庐的 Linux sysadmin 如何从这样的问题中恢复？对于门外汉来说,`grub`命令行是一个难以理解的谜，但是一旦你理解了基础知识，启动你的系统并尝试恢复正常的启动过程就不是很难了。当然，这取决于打破了什么。如果包含您的根分区的磁盘崩溃了，那么对不起，这篇文章不会有帮助。

为了让系统启动，到底需要做什么？引导 Linux 是如何工作的呢？需要将两个组件加载到内存中:内核和`initramfs`。一旦这两个元素被加载到内存中，`grub`就会跳转到内核代码中，内核代码接管并完成机器的引导。还有一个我们关心的更重要的细节——内核需要知道在哪里可以找到根分区。这通常是内核参数的一部分，在内核启动行上指定。

当使用不熟悉的 shell 时，help 命令是一个很好的起点。`grub`在非常有限的环境下运行，运行 help 命令会将大部分文本滚动出屏幕。这里有一个环境变量可以帮助实现输出分页:`set pager=1.`

### 找到你要找的东西

`ls`是你的朋友。不知道哪个驱动器是哪个？`ls`来救援。`grub`使用一种独特的命名法来访问分区。您可能会看到类似于(HD0，0)或(hd0，msdos1)的条目。现代的`grub`甚至可以让你使用`ls (hd0,msdos1)/`这样的命令列出分区中包含的文件和文件夹。

我们想从找出哪个分区存储内核和`initrd`文件开始。这些文件可能在一个引导文件夹中，或者就在其中一个分区中。内核一般命名为 vmlinuz-kernel _ version . architecture 所以比如:`vmlinuz-5.3.7-200.fc30.x86_64`。我们需要的 initrd 将匹配内核的版本。类似`initramfs-5.3.7-200.fc30.x86_64.img`的东西。

最后需要的信息，根文件系统的位置，可能比较难找到。在搜索分区时，您可能会发现一个具有根文件系统布局的分区，包含`boot`、`bin`、`etc`、`home`等。你可以根据`grub.`
`hd0`中的名字大概是`sda`，`hd1`大概是`sdb`来推测内核会怎么称呼这个分区。`grub's`名的后半部分告诉你是哪个分区，所以`(hd0,msdos1)`很可能是`sda1`。

### 把它放在一起

为了实际启动，我们在`grub`中发出三个命令。第一个命令设置内核映像和任何内核引导选项。一个必需的选项是设置根位置:`linux (hd0,msdos1)/boot/vmlinuz-4.19.0-6-amd64 root=/dev/sda1`
接下来我们设置 initrd 选项:`initrd (hd0,msdos1)/boot/initrd.img-4.19.0-6-amd64`

一旦设置好这些选项，我们就可以告诉`grub`尝试引导内核。这是一个简单的命令:`boot`

假设我们设置了正确的选项，并且系统没有崩溃，这将引导您的机器回到正常状态。是时候排除导致`grub`出轨的原因了。不过，那是以后的事了。

既然我们在这里，还有一些其他关于`grub`和引导的技巧值得了解。最有用的可能是单用户模式，通过在引导选项中添加“1”来启用。


在某些发行版中，这甚至绕过了知道 root 密码的需要，如果您发现自己被锁定在系统之外，这是很有用的。许多现代系统仍然需要以 root 身份登录才能继续。不过，单用户模式有助于解决其他引导和系统问题。
你还有一个锦囊妙计，那就是将司机列入黑名单。例如，添加`blacklist amdgpu`将完全阻止`amdgpu`驱动程序的加载，而不管硬件是否存在。如果一个错误或错误配置的驱动程序在启动时导致崩溃，将其列入黑名单可能会让你成功启动。

希望这足以让您在下次调试 Linux 引导问题时有优势，并为您的清单增加一些工具。黑客快乐。