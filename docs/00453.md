# Docker 简介:为什么以及如何在任何系统上使用容器

> 原文:[https://hack aday . com/2018/09/05/intro-to-docker-why-and-how-to-use-containers-on-any-system/](https://hackaday.com/2018/09/05/intro-to-docker-why-and-how-to-use-containers-on-any-system/)

如果你对软件社区稍有耳闻，你就会听说过 [Docker](https://www.docker.com/) 。最近，它越来越受欢迎，并继续快速吸引用户，包括许多基础设施依赖于它的全球性公司。Docker 的成名部分可以归功于其用户成为具有福音派倾向的即时粉丝。

但是流行的背后是什么，又是如何运作的呢？让我们先进行一个概念性的介绍，然后通过动手实践来探索 Docker。

## Docker 是什么？

Docker 允许你在一个叫做**容器**的隔离环境中运行软件。容器类似于虚拟机(VM ),但是以完全不同的方式运行(我们很快会谈到)。虽然提供了 VM 所提供的大部分隔离，但容器只使用了一小部分资源。

## 为什么它很棒

在我们深入技术细节之前，您为什么要关心呢？

### 一致性

假设您正在编写一个 web 应用程序。您在本地机器上开发它，并在那里进行测试。你有时会在一个临时服务器上运行它，很快你就会把它放在一个大型的生产服务器上让全世界看到。

如果你能在你所有的设备上持续地运行相同的环境，那不是很好吗？如果您的 web 应用程序在本地机器上的 Docker 容器中正确运行，它可以在测试服务器上运行，可以在生产服务器上运行，可以在任何地方运行。

这使得管理项目依赖关系变得非常容易。不仅处理由代码直接调用的外部库和模块很简单，而且整个系统可以根据您的喜好进行配置。如果您有一个新用户想要下载并运行的开源项目，这就像启动一个容器一样简单。

受益于可再生环境的不仅仅是运行代码——在容器中构建代码也很常见；我们写了关于[使用 Docker 为 Raspberry Pi](https://hackaday.com/2016/09/01/how-to-use-docker-to-cross-compile-for-raspberry-pi-and-more/) 交叉编译。

### 可量测性

如果您使用 Docker 来创建具有不同需求的服务(比如网站或 API)，那么通过简单地启动更多的容器就可以非常容易地扩展您的供应(前提是所有的东西都正确地进行了架构设计)。有许多用于编排容器集群的框架，比如 Kubernetes 和 Docker Swarm，但那是另外一个故事了。

## 它是如何工作的

容器非常聪明。虚拟机运行在模拟硬件上，是一个完全独立的操作系统。然而，容器本身就共享主机的内核。你可以看到下面的区别。

![](../Images/3219fde80971d3d6f3c8f428020ffeed.png)

这意味着容器的性能比虚拟机好得多。当我们谈论 Docker 时，我们谈论的是我们可以运行多少 Linux 进程，而不是我们可以同时运行多少操作系统。根据他们在做什么，有可能在你的电脑上安装数百个甚至数千个容器。此外，启动一个容器只需几秒钟或更短时间，而许多虚拟机需要几分钟。因为容器是如此的轻量级，所以通常的做法是在不同的容器中运行应用程序的所有方面，以获得压倒性的可维护性和模块化。例如，数据库服务器、redis、nginx 等可能有不同的容器。

但是如果容器共享主机内核，那么它们是如何分离的呢？有一些非常巧妙的低级诡计正在进行，但是您需要知道的是, [Linux 名称空间](https://medium.com/@teddyking/linux-namespaces-850489d3ccf)被大量利用，导致看起来是一个完全独立的容器，拥有自己的网络接口等等。然而，容器和主机之间的屏障仍然比使用虚拟机时弱，因此对于安全关键型应用程序，一些人会建议避开容器。

## 我如何使用它？

例如，我们将在 Docker 容器中构建一个最小的 web 服务器。为了保持简单，我们将使用 Flask，一个 Python web 微框架。这是我们想要运行的程序，`main.py`:

```

from flask import Flask

app = Flask(__name__)

@app.route('/')
def home():
    return 'Hello from inside a Docker container';

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=80)

```

如果您不熟悉 Flask，也不要担心；您需要知道的是，这段代码在`localhost:80`上提供一个字符串。

### 在容器内运行流程

那么我们如何在一个容器中运行它呢？容器由一个**图像**定义，它就像一个容器的配方。容器只是一个图像的运行实例(这意味着同一图像可以有多个运行容器)。

我们如何获得图像？Docker Hub 是一个公开的图片集合，其中有官方贡献，但也允许任何人推送自己的图片。我们可以从 Docker hub 获取一个图像并扩展它，这样它就可以做我们想要的事情。为此，我们需要编写一个`**Dockerfile**`——一个构建图像的指令列表。

在`Dockerfile`中，我们要做的第一件事是指定我们想要使用/扩展哪个图像。作为起点，选择一个已经安装了 Python 的映像是有意义的。谢天谢地，有一个维护得很好的 Python 映像，它有多种风格。我们将使用一个运行在 Debian stretch 上的 Python 3.7。

这是我们的`Dockerfile`:

```

FROM python:3.7-stretch

COPY app/ /app
WORKDIR /app

RUN pip install Flask
CMD ["python", "main.py"]

```

在我们讨论的第一行之后，`Dockerfile`的其余部分就不言自明了。我们有一个层级结构，如下所示:

```
app
└──main.py
Dockerfile
```

所以我们的`app/`目录被复制到容器中，我们使用它作为工作目录来运行其余的命令。我们使用`pip`来安装`Flask`，最后指定容器启动时运行的命令。请注意，该命令启动的进程将固有地绑定到容器:如果进程退出，容器将会死亡。如果您正确使用 Docker，这(通常)是一件好事，每个容器中只运行一个进程/项目块。

### 建立形象

好了，我们已经写了一些关于如何建立我们的形象的说明，让我们来建立它。

```
$ docker build .

```

这告诉 Docker 在当前目录(`.`)中查找一个`Dockerfile`。但是为了使它更容易运行，让我们给我们构建的映像起一个名字，叫做**标签**。

```
$ docker build -t flask-hello .

```

由于这是我们第一次从 hub 使用这个 Python 映像，下载需要一两分钟，但是将来，它将在本地可用。

现在我们有了一个闪亮的新图像，我们可以运行它来生成一个容器！就像这样简单:

```
$ docker run flask-hello
```

![](../Images/b9a1a718efd3be6ffb691c35b4a25c7a.png)

我们的容器运行成功，我们从 Flask 得到一些输出，表明它已经准备好为我们的页面提供服务了。但是如果我们打开浏览器，访问`localhost`，什么也看不到。原因当然是我们的服务器运行在容器内部，容器有一个隔离的网络栈。我们需要转发端口 80 才能访问我们的服务器。所以让我们用 CTRL+C 杀死容器，用一个端口 forward 再次运行它。

```
$ docker run -p 80:80 flask-hello
```

…而且很有效！

## 摘要

第一次看到这个过程时，可能会觉得有点冗长。但是有像`docker-compose`这样的工具来自动化这个工作流，这在运行多个容器/服务时非常强大。

我们会告诉你一个秘密:一旦你熟悉了 Docker，你就会感觉自己是精英俱乐部的一员。你可以很容易地下载并运行任何人的软件，不需要任何设置，只需要击键。

*   Docker 是在可复制的跨平台环境中运行代码的一种极好的方式。
*   一旦建立了映像，您就可以随时随地运行代码。
*   在不同的容器中构建应用程序的不同组件是使应用程序易于维护的好方法。
*   尽管本文将 web 服务作为一个例子，但是 Docker 可以在很多地方提供帮助。

容器、容器编排和可伸缩部署是现在值得关注的令人兴奋的领域，发展日新月异。这是一个享受乐趣的好时机！