# 使用正确的网络协议超越堆栈

> 原文:[https://hack aday . com/2019/04/09/超越具有正确网络协议的堆栈/](https://hackaday.com/2019/04/09/transcending-the-stack-with-the-right-network-protocol/)

过去几年联网设备的增加是一把双刃剑。虽然一方面，有一种简单直接的方法让设备相互通信确实很好，但这也带来了一系列复杂问题，主要与可靠性和安全性有关。

使用 WiFi，将新设备集成到网络中比使用以太网或 CAN 要复杂得多，并且安全性(例如 WPA 和 TLS)不再是可选的，因为对网络结构的物理访问不再受到限制。此外，由于附近竞争的 WiFi 网络和其他电磁噪声源的干扰，可靠性问题也变得更加严重，在考虑应该使用哪种顶层通信协议之前，事情已经变得相当复杂。

在本文中，我们将研究如何实现这样一个基于网络的系统，使用 TLS 保护 WiFi 网络，以及将 MQTT 与代理结合使用。我将利用我在[的上一篇文章](https://hackaday.com/2019/03/20/the-joy-of-properly-designed-embedded-systems/)中提到的这个[建筑管理和控制](https://github.com/MayaPosch/BMaC) (BMaC)项目中获得的经验和教训来说明这一点。

## 让 MQTT 进入您的系统

消息队列遥测传输( [MQTT](https://en.wikipedia.org/wiki/MQTT) )是一个小型的二进制协议，是由 [IBM](https://en.wikipedia.org/wiki/IBM "IBM") 的[安迪·斯坦福-克拉克](https://en.wikipedia.org/wiki/Andy_Stanford-Clark "Andy Stanford-Clark")和 Cirrus Link 的阿尔伦·尼珀在 1999 年开发的。它的 3.1 版本于 2013 年由 IBM 提交给 OASIS 进行标准化。MQTT 的另一个版本是 MQTT-SN，它是为低带宽、非 TCP 网络设计的，比如 Zigbee、UDP 和蓝牙。

由于其紧凑的尺寸和简单的客户端-服务器架构，它非常适合连接较大和较小的传感器网络，尤其是在高延迟、低带宽的情况下。它使用订阅-发布模型，客户端可以订阅主题，其他人可以在主题上发布消息。这些消息可以是持久的，有保证的传递，并且(从版本 5 开始)如果不能传递，可以自动过期。

MQTT 的明显优势是，它支持从始终在线的高带宽客户端到低功耗的远程传感器节点的一切，这些节点每周醒来，拨入卫星链路并发送一些传感器读数，同时根据同时从其他客户端接收的数据更新其校准设置。

![](../Images/bb4f5193c4f122e022e9f01a75c6137d.png)

在 BMaC 项目中使用 MQTT(带有 Mosquitto MQTT 代理)最初更多的是一种巧合，我们使用它主要是因为 MQTT 客户端已经集成到我们在微控制器上使用的框架中。我们中没有人真正考虑过 MQTT 相对于任何替代方案的优缺点。现在，多年以后，很容易理解为什么 MQTT 是正确的选择。当在内部的基于 TCP 的网络上运行它时，我们得到了 TCP 有保证的交付方面及其内置的校验和验证，MQTT 协议本身对它可以携带的有效负载没有任何限制，无论它是基于文本的还是二进制的。

MQTT 的真正竞争并不存在。AMQP 也相当受欢迎，但它针对的是企业环境中的桌面和服务器系统，并没有真正缩小到内存受限的 8 位微控制器。此外，AMQP 还为有效载荷定义了一种编码方案，而 MQTT 则允许用户自由选择自己想使用的编码或序列化方案。

有了 BMaC，我们就可以开发自己的有效载荷格式，在基于 ESP8266 的节点之间来回发送。这导致了一种紧凑的二进制格式，最多只使用几个字节，就足以通过 MQTT 配置节点以及调整风扇和中继设置。

## 保护系统

保护系统的最佳方式是通过深度安全实践。这意味着每一个可以被利用的部分都应该以某种方式得到保护。假设有一个像 BMaC 这样的系统，这意味着物理硬件都在一个办公楼内，办公楼安装了自己的安全系统。

该安全系统可以是简单的机械锁，或者一些基于 NFC 标签的系统。服务器机房等敏感区域需要自己的访问密钥或与 NFC 标签相关的许可。这实际上消除了未经授权的个人访问硬件的任何风险，更不用说执行任何恶意操作了。

像这样的系统的无线网络当然是由 WPA2 或类似的安全，这意味着没有正确的密码或证书，一个人不能连接到无线网络。因此，网络上的任何流量都将被加密。这将最有可能的威胁转移到那些以某种方式获得网络访问权限的人身上，无论是通过合法手段，还是因为 WiFi SSID 和密码在上市公司博客(真实故事)上发布的照片中。

在这一点上，我们有一个不错的安全级别，但缺少的要素是保护节点和后端服务器之间的流量，这意味着要么是 TLS 加密(非常常见)，要么是[椭圆曲线加密](https://en.wikipedia.org/wiki/Elliptic-curve_cryptography) (ECC)，这将是更好的选择，因为它更快，需要更少的 RAM，并且证书更小。不幸的是，ECC 已经退居 TLS 之后，主要是因为它被专利保护的时间要长得多。

这使得 TLS 更容易集成到 BMaC 项目中，因为添加 ECC 意味着放弃我们用于 ESP8266 节点的框架中的 axTLS 库，并集成一个支持 ECC 的备用库，也适合该微控制器提供的有限 RAM。

## 事情变得繁荣的部分

我们很快发现，TCP 连接的 TLS 加密中的默认握手设置会给 ESP8266 和类似的 MCU 带来大量问题，当握手事件发生时，这些 MCU 的可用 SRAM 往往少于 30 kB。

![](../Images/75bad579e042b2edc40352b0b01e1674.png)

默认 TLS 配置规定，当尝试安全连接时，分配最大 TX/RX 缓冲区大小，每个 16 kB，或总共 32 kB。对于重要的固件，这会导致 MCU 耗尽内存并重置 MCU。幸运的是，这个设置可以在服务器端更改，正如本文中关于 TLS 的[所提到的。这将允许服务器将 TLS 缓冲区大小设置为适合 MCU 的 SRAM 的大小。](https://hpbn.co/transport-layer-security-tls/#optimize-tls-record-size)

对于 BMaC 来说，可悲的是 Mosquitto MQTT 代理上的服务器没有这个配置设置，需要我们在源代码中修改它并重新编译服务器。这似乎有点过头了。

相反，我们选择将[一个不同的 TLS 端点](https://www.igvita.com/2013/10/24/optimizing-tls-record-size-and-buffering-latency/)添加到系统中，使用 [HAProxy](http://www.haproxy.org/) 作为中间节点。我们配置了一个仅支持 TLS 访问的接口，该接口通过本地主机回送接口将任何解密的数据路由到 Mosquitto，并将 [tune.ssl.maxrecord 属性](http://cbonte.github.io/haproxy-dconv/1.9/configuration.html#3.2-tune.ssl.maxrecord)设置为 2 kB，以在 ESP8266 上获得 4 kB 的缓冲空间。在分别在 HAProxy 和 BMaC 节点固件上启用服务器和客户端证书后，我们建立了一个 TLS 加密的连接，确保即使是我们的同事也无法嗅探我们在做什么。

## 把它放在一起

当我们完成办公室空调系统的第一个控制器的接线时，BMaC 项目包括一个运动、温度、二氧化碳、气压和咖啡使用传感器的无线网络，以及一系列继电器和风扇控制器，所有这些都使用中央后端服务器和安全 MQTT 连接连接在一起..

在设置好网络之后，使用客户端证书来保护 MQTT，以确保只有真正的 BMaC MQTT 客户端可以连接，能够专注于在节点和后端之间传输命令和数据是非常好的。真正让我恼火的唯一问题是缺少一个 MQTT 桌面客户端，它允许我进行 MQTT 监控、主动主题发现，并与二进制有效负载直接兼容，而不是假设人们只会将 MQTT 用于基于文本的有效负载。

这促使我开发了一个基于 C++/Qt 的 MQTT 桌面客户端，名为 [MQTTCute](https://github.com/MayaPosch/MQTTCute) 。这是我希望从一开始就拥有的客户，因为我正在设置整个系统，试图了解 MQTT 主题上正在发送的内容。因为我们最终为 BMaC 使用了二进制协议，所以在桌面客户机中内置十六进制视图功能是非常宝贵的。

不管怎样，如果我们必须再做一次，用我们获得的知识，我们仍然会选择同样的路线。我们可能会尝试使用 ECC 而不是 TLS，但是，这只是为了节省使用额外的 TLS 端点和代理服务器的开销。

我们还发现许多 MQTT 库采用基于文本的有效负载，并且会使用 C 函数，如 strlen()和 kin。他们中的许多人已经收到了来自您的 truly 的 pull 请求，因此这些库现在可以愉快地接受您希望通过 MQTT 发送的任何二进制数据，包括图像。

## 房间里的大象

当谈到 MQTT 和类似的客户机代理系统时，总是有这样的争论，即它们不可靠，因为它们有一个以 MQTT 代理形式出现的单点故障。这绝对是一个有道理的观点，但也不像人们想象的那么有道理。

MQTT 代理倾向于运行在可靠的服务器硬件上，在 BMaC 作为存储集群上的 Linux 虚拟机实例的情况下。对于经纪人来说，突然从网络上消失将需要一种灾难性的失败，使公司的网络瘫痪。

可以设想在一个辅助地址上建立第二个、备用的 MQTT 代理，但是如果没有好的理由，这将是大量的工作。在我们自己长达一年的 BMaC 开发过程中，Mosquitto 代理零故障，而(旧的)WiFi 接入点故障问题更多。