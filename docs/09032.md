# 树莓派进入微控制器游戏，售价 4 美元

> 原文:[https://hack aday . com/2021/01/20/raspberry-pi-entries-micro controller-game-with-4-pico/](https://hackaday.com/2021/01/20/raspberry-pi-enters-microcontroller-game-with-4-pico/)

Raspberry Pi 是单板 Linux 计算机的同义词。不再是了。4 美元的 Raspberry Pi Pico 板是他们试图打入拥挤的微控制器模块市场的尝试。

有问题的微控制器 RP2040 也是 Raspberry Pi 首次涉足定制硅，它有一个双核 Cortex M0+,带有大量 SRAM 和一些非常有趣的定制 I/O 外设硬件，这可能意味着你再也不用 bit-bang 了。但是，如果没有开发板，裸露的微控制器就没有意思了，Raspberry Pi Pico 增加了 2 MB 的闪存、USB 连接和良好的电源管理。

与 Raspberry Pi Linux 机器一样，重点是让您快速启动和运行，并且有丰富的文档:从带有[代码示例](https://github.com/raspberrypi/pico-examples)的 C/C++和 MicroPython SDKs 的“入门”类型指南，到 [Pico](https://datasheets.raspberrypi.org/pico/pico_datasheet.pdf) 和 [RP2040](https://datasheets.raspberrypi.org/rp2040/rp2040_datasheet.pdf) 本身的重要数据表，到硬件设计笔记和 KiCAD 分线板，甚至是板载引导 ROM 的[内容。Pico 似乎旨在友好地介绍使用 MicroPython 的微控制器，但有足够的指导供您深入兔子洞。](https://github.com/raspberrypi/pico-bootrom)

我们的快速了解:RP2040 是一款经过深思熟虑的微控制器，拥有无数精美的设计，足以完成大多数工作的功率，以及一款创新且非常适合黑客的软件定义的硬件 I/O 外设。它由良好的文档和许多工作示例支持，最终运行一对熟悉的 ARM MO+ CPU 内核。如果它以 4 美元的价格上市，我们可以看到它成为许多不需要无线连接的项目的首选。

但是你想要更多的细节，对吗？请继续阅读。

## 规格和奢侈品

在许多方面，Pico 都是一个精心设计的“普通”微控制器板。它具有 26 个 3.3V gpio、一个标准 ARM 串行线调试(SWD)端口、USB 主机或设备功能、两个 UARTs、两个 I2C、两个 SPI 和八组 16 个 PWM 通道。(PWM 单元还可以测量输入的 PWM 信号，包括其频率和占空比。)Pico 有一个 12 位 ADC，尽管它只连接到~~四个~~三个引脚，所以你必须小心。(编者注:RP2040 有四个 ADC，但第四个在 Pico 上不可用。)

[![](../Images/0ae5f44a30e7dd63338fe1a80967070c.png)T2】](https://hackaday.com/wp-content/uploads/2021/01/pico_pinout.png)

双臂 M0+内核运行于 PLL 之上，最高可达 133 MHz，速度非常快。几乎每个外设都有独立的时钟分频器，它们可以像大多数其他 ARM 微控制器一样单独开启和关闭以节省功耗。它以约 100mA(5V)的功耗全速运行，并具有 1 mA 以下的全记忆保持睡眠模式。

与 ESP8266 和 ESP32 模块一样，它使用外部闪存 ROM 来存储程序，并且可以直接从闪存运行代码，就像它是内部存储器一样。Pico 板配有一个体面的 2 MB QSPI 闪存芯片，但如果你有烙铁，你可以安装高达 16 MB。它有 264 kB 的 SRAM，这当然很舒服。RAM 在内部被分成四个 64 kB 的分条存储体，用于快速并行访问，但如果您愿意，它们也可以单独访问。另外两个 4 kB 内存块是非条带化的，建议将它们自己用作每个内核的堆栈内存，但也没有任何东西强迫您这样使用它们。

有许多小的硬件级的便利。所有的配置寄存器都是 32 位宽，因此您可能不想指定所有的寄存器，或者您可能想避免读-修改-写之舞。像许多 STM32 芯片一样，它有一个特殊的存储器映射，允许您在一个原子命令中设置、清除或异或任何配置寄存器中的任何位。还有 30 个 GPIOs，所以它们都可以放在一个 32 位寄存器中——没有端口 B、引脚 7 之类的东西。这也意味着您可以一次性读取或写入它们，同时通过上述原子访问设置单个引脚很容易。

[![](../Images/8cd3fb36998e3a5385a302696f8e3ddf.png)](https://hackaday.com/wp-content/uploads/2021/01/DSCF2201_thumbnail.png) 一个内部掩膜 ROM 包含 UF2 引导加载程序，这意味着你可以随时将芯片重新置于控制之下。当你按住 BOOTSEL 按钮插入 Pico 时，它会显示为一个 USB 大容量存储设备，你可以在没有程序员的情况下复制你的代码，Raspberry 甚至提供了一个全零文件，你可以复制它来彻底清除机器。然而，如果你复制 Pico 的 MicroPython 二进制文件，你就再也不需要引导程序了。mask ROM 还包含一些支持整数和浮点数学的快速例程，所有内容都是开源的，如上所述。

板载电源调节是一种升压-降压配置，输入范围为 1.8 V 至 5 V，例如，这对于锂电池来说是一个很好的范围，但这可能是一个麻烦，因为它们既可以在 IC 的 3.3 V 以上运行，也可以在 IC 的 3.3V 以下运行，因此最好有一个升压-降压调节器来挤出最后的几毫安小时。或者你可以在两个 AAs 上运行你的项目。真好。

因此，Pico/RP2040 是一款功能强大的现代开发板，具有一些贴心的设计。但事情会变得更好。

## PIO:再也不要咬邦了

RP2040 和 Pico 上真正出众的外设是可编程 I/O (PIO)硬件，它允许您定义自己的数字通信外设。有两个这样的 PIO 单元，每个单元有四个可编程状态机，运行用特殊的 PIO 汇编语言编写的顺序程序。每个状态机都有自己的时钟分频器、寄存器存储器、IRQ 标志、DMA 接口和 GPIO 映射。这些允许基本上任意的周期精确的 I/O，做繁重的工作，这样 CPU 就不必做了。

[![](../Images/debfd3d8b7e55f08ca2028a48cbec683.png)](https://hackaday.com/wp-content/uploads/2021/01/DSCF2199_thumbnail.png) 例如，如果你想编程另一个 UART，这很简单。但曼彻斯特编码的 UART，或者格雷码编码器/解码器，甚至更花哨的技巧也是如此。一个示例应用是 DPI 视频示例，其中一个状态机处理扫描线时序和像素时钟，而另一个状态机推出像素数据并对其进行游程编码。这些都是简单但快速的任务，会使 CPU 陷入困境，导致定时故障，所以专用硬件是正确的解决方案。

Pio 具有 CPLD 或 FPGA 的灵活性，但更易于编程。每个状态机只能带一个 32 条指令长的“程序”，但是“pioasm”语言非常密集。例如，设置引脚状态的命令也有一个参数，表示引脚设置后要等待多长时间，在同一条指令中可以旋转附加的“侧置”引脚。因此，只需一条指令，您就可以提高时钟线，设置您的数据，并在规定的时间内保持这种状态。SPI 主机 TX 的基本实现是两条线。

或者以 WS2812 LED 协议为例。要发送逻辑 1，需要将自同步数据线长时间保持高电平，短时间保持低电平。为了发送逻辑 0，数据线短时间保持高电平，长时间保持低电平。创建在 CPU 中以合理的速度完成这一任务的例程，而不出现故障，这需要黑客付出不小的代价。使用 PIO 外设，编写一个例程以绝对周期精度移出这些位是很简单的，一旦完成，您的代码可以简单地将 RGB 值写入 PIO，剩下的就交给我们了。

为了从 C 运行 PIO 代码，汇编程序在编译时被调用，程序被转换成机器语言并作为矩阵存储在头文件中，然后可以从`main()`内部写入 PIO 设备以初始化它。在 Python 中，这甚至更简单——`@asm_pio`装饰器将函数转化为 PIO 代码。你只需要用九条 PIO 汇编指令编写“Python”函数，然后把它接到 GPIO 管脚上。之后，您可以从代码中调用它，就像它是一个普通的外设一样。

PIO 是 Pico/RP2040 最酷的功能，虽然只玩了一点点。这只是一点点周期正确的可编程逻辑，但大多数时候，这就是你所需要的。如果你不想学习一门新的汇编语言——尽管只有九条指令——已经有很多例子了，一旦主板上市，人们肯定会开发更多。

## ide 和 SDKs 和 MicroPython

Raspberry Pi 单板计算机(SBC ),当与它们的文档和例子结合起来时，通常能够很好地混合新手所需的简单性，同时又不会隐藏太多。结果是，您以一种友好的方式了解了它，而不是抽象出底层系统的 Linux 性。这似乎是 Raspberries 通过 Pico 瞄准的目标——通过文档和 MicroPython 的易用性对微控制器进行了友好的介绍，但当你转向 C/C++代码时，这也不会有任何影响。

[![](../Images/b61924be8eb74585ca3a4ab54e52c39b.png)](https://hackaday.com/wp-content/uploads/2021/01/DSCF2183_thumbnail.png)

USB for power, UART for communication, and SWD for programming and debugging.

手头有一个 Raspberry Pi SBC 可以简化很多最核心的微控制器。例如，如果你想在芯片上进行调试，你需要通过 SWD 接口连接，为此你通常需要一个程序员。当然，你也可以用 Raspberry Pi SBC 的 GPIOs 对 SWD 控制器进行 bit-bang，但是你必须正确配置 OpenOCD 才能这样做。

如果这些听起来像是胡言乱语，不要担心——所有这些都由一个简单的`pico_setup.sh`脚本处理。它不仅安装所有的编译和调试环境，还(可选地)为您下载 VScode。很好。

你*最终会*想要通过 SWD 对它进行编程。拔出 USB，按住按钮，然后重新插入 USB 的循环很快就过时了。

如果你是一个命令行迷，C SDK 的构建系统是基于 CMake 的，如果你已经安装了 ARM 工具链，从命令行运行就很好。和所有 SDK 一样，启动新的编码会话需要一定量的样板文件。这是由 [pico 项目生成器](https://github.com/raspberrypi/pico-project-generator)负责的，所以您不必这么做。

在“入门”指南中，您将找到在 Raspberry Pi SBC、Windows、Mac 或桌面 Linux 机器上设置环境的说明。如果您喜欢将 Eclipse 作为 IDE，那么也有集成说明。

## 双核:这里有龙

如果有一个领域给我留下了尚未完全开发的印象，那就是系统的双核方面。现在，如果您编写 C 或 Python 代码，它运行在核心 0 上，而核心 1 只是处于闲置状态。C 和 Python SDK 文档都告诉您如何在另一个内核上启动一个线程，也有可用的示例代码，但是指令很少。在 C 中，有一个`pico/multicore.h`甚至互斥体、信号量和队列库供您包含，但是文档警告说大多数`stdlib`函数不是线程安全的。在 Python 中你`import _thread`并调用了`start_new_thread()`方法，但我不知道你有多少细粒度的控制。

如果以上这些听起来很可怕，那么，确实有点。为多处理器系统编码的事实是，它为出错开辟了新的途径，因为一个 CPU 改变另一个 CPU 下的值，或者它们都试图同时写入 UART。我们写了 Raspberries 并询问他们是否计划移植 RTOS，这为问题提供了更多的结构，他们回答说这实际上是他们完成发布后的第一件事。因此，除非您知道自己在做什么，否则您可能还没有获得双核芯片的全部优势。但是，我们真诚地期待 RTOS 得到覆盆子 Pi 文档和教程的待遇。

## 深刻的想法

你并不是每天都能看到一个新玩家进入微控制器市场，更别说是一个拥有 Raspberry Pi 的黑客友好资格的玩家了。就这一点而言，这个董事会是值得注意的。但功能集也是可靠的，在硅和支持中都有许多舒适的东西，它以 PIO 单元的形式为桌面带来了一个真正的新功能。加上 4 美元的价格标签，你可以想象它成为人们的首选——在你不需要无线连接的时候。

[![](../Images/21b2cc89944772095d6fba51521998de.png)](https://hackaday.com/wp-content/uploads/2021/01/DSCF2207_thumbnail.png) 的确，就性价比而言，该板唯一真正的竞争对手是各种 ESP32 板。但它们也是非常不同的动物——一个提供较少的 GPIO，但具有广泛的无线功能，另一个有更多(也更灵活)的 GPIO，设备*和*主机 USB，但没有无线电。在关闭无线功能的情况下，全速运行时的功耗对于 ESP32 来说是一个轻微的优势，但 Pico 的睡眠模式稍微节省一些。两个 SDK 都是用 C 完成的，并且都运行 MicroPython。ESP32 的双核运行自由操作系统，但我们认为不久之后，这一竞争环境就会变得公平。所以基本上归结为 WiFi vs USB。

当然，花稍微少一点的钱，你就可以买到一个基于 STM32 的" [Black Pill](https://hackaday.com/2021/01/20/blue-pill-vs-black-pill-transitioning-from-stm32f103-to-stm32f411/) "板，还有另外一套利弊。选择，选择！

随着 Pico 的出现，Raspberry Pi 进入了一个拥挤的领域。他们已经有了知名度，一个很酷的硬件技巧，一个很棒的价值主张，以及可靠文档的跟踪记录。如果我正在编写一个不需要无线的 GPIO 密集型应用程序，Pico 将是一个可靠的选择，特别是如果我可以利用额外的内核的话。

我给你留一个难题:在 RP2040 数据手册的第 9 页，他们列出了“2040”的含义:两个内核，M0+型，256 kB 以上的 RAM，以及 0 kB 闪存。这是否意味着我们最终会看到拥有更多内存、板载闪存或不同 ARM 内核的机型？RP2050？RP2048？在评论里胡乱揣测。