# 本周安全:共生体研究和检测，路由劫持，Bruggling，等等

> 原文:[https://hackaday . com/2022/08/05/this-week-in-security-symbiote-research-and-detection-routing-hijacks-bruggling-and-more/](https://hackaday.com/2022/08/05/this-week-in-security-symbiote-research-and-detection-routing-hijacks-bruggling-and-more/)

[上周我们报道了 Symbiote Rootkit](https://hackaday.com/2022/07/29/this-week-in-security-symbiote-smart-locks-and-cosmicstrand/) ，基于黑莓、Intezer 和网络极客的出色工作。这种特殊的恶意软件采取了一些特别聪明和迂回的步骤来隐藏。它使用一个`LD_PRELOAD`来实时干扰系统库，对用户和检测工具隐藏某些文件、进程、端口甚至流量。详情请阅读上周的专栏和链接的源文章。

有一种检测 rootkit 的通用技术，其中一种工具创建一个模仿 rootkit 元素的文件或进程，然后检查是否有任何假货神秘地消失了。在阅读关于 Symbiote 的文章时，我寻找了一些我们可以推荐的工具，这些工具使用这种技术来检查感染。接下来，我掸掉安全研究员的帽子，开始工作。Intezer 的一个非常有用的指针把我带到了 MalwareBazaar 关于 Symbiote 的页面。请注意，该页面包含实时恶意软件样本。不要轻易下载。

这给我们带来了我们需要解决的第一个大问题。你如何处理恶意软件而不感染你的机器和更广泛的网络？虚拟化可能是答案的重要组成部分。恶意软件感染虚拟机，然后跳过这个间隙感染主机，这确实是一个很大的飞跃。一点小心的设置可以使它更加安全。首先，为您的 VM 主机和研究客户机使用不同的操作系统或发行版。复杂的恶意软件往往具有很强的针对性，给定的示例不太可能支持两个不同的发行版。裸机主机是为了获得最佳安全性而安装的最新版本，但是受害者呢？

虽然我们想要一个防弹的基础，但我们的研究虚拟机需要是易受攻击的。如果恶意软件的目标是特定的内核版本或库，我们甚至需要确切的版本才能开始。不幸的是，MalwareBazaar 上的样品不包括它们被发现的机器的细节，但它们确实带有其他分析工具的链接，如 [Intezer Analyze](https://analyze.intezer.com/analyses/afe1bb01-3f37-4c6f-b34d-b84cb58a3a85/sub/20dc778f-9cac-49cb-adf3-e74ed5d15f84/string-reuse) 。一个特殊的嵌入字符串引起了我的注意:`GCC: (GNU) 4.4.7 20120313 (Red Hat 4.4.7-17)`这可能来自编译这个特殊共生体样本的机器，这似乎是一个很好的起点。GCC 4.4.7-17 随 Red Hat Enterprise Linux 版本 6.8 一起提供。因此，我们获取了 CentOS 6.8 live DVD ISO，并让它在我们的虚拟机主机上启动。

下一步是直接从 MalwareBazaar 下载恶意软件样本。它们装在加密的拉链里，只是为了让自己更难被意外感染。除了预定目标，我们不希望它们在任何地方着陆。我更进一步，断开了虚拟网络适配器和物理网络电缆，以真正隔离我的研究环境。我有了我的恶意软件和可能的目标，是时候测试我的理论了，Symbiote 太努力地偷偷摸摸，如果我捅得恰到好处，它会发出警报。

[![](../Images/061def4bea2d87b1e0f84b7a6621316b.png)T2】](https://hackaday.com/wp-content/uploads/2022/08/Screenshot-from-2022-08-03-16-45-59.png)

成功！我们使用`touch`来创建一个名为`java.h`的文件，并使用`ls`来验证它确实存在。然后，加上`LD_PRELOAD`再运行`ls`，`java.h`就神秘失踪了。类似的技巧也适用于检测进程隐藏。我们通过将`while true; do sleep 1; done`写入脚本来将`java.h`转换成脚本。在后台运行脚本，看看它是否在`ps -A -caf`中列出。对于 Symbiote 隐藏列表中的文件名，它也会消失。最好的部分是我们可以编写这个检测脚本。我给你， [`sym-test.sh`](https://github.com/jp-bennett/symbiote-test/blob/main/sym-test.sh) 。它为每个已知的 Symbiote 文件创建并运行一个简单的脚本，然后使用`ls`和`ps`来寻找脚本。一种像我们在野外看到的样本一样工作的共生体变体会泄露它的存在并被检测到。如果你通过这个脚本在你的机器上找到了 Symbiote，一定要让我们知道！

## BGP 劫持—可能

上周 BGP 有点奇怪，俄罗斯电信公司 Rostelecom 宣布 17.70.96.0/19 的路由。这部分知识产权归苹果所有，所有迹象都表明这是一次未经授权的发布。边界网关协议 BGP 是您可能没有听说过的最重要的网络协议之一，它实际上承载着如何在全球范围内路由互联网流量的指令。历史上也没有任何固定的安全协议，只是依赖于所有玩家的良好行为。有 [RPKI](https://blog.cloudflare.com/rpki/) ，一个路由更新加密签名的新标准，但它不是一个硬性要求，还没有广泛部署。

BGP 在没有任何安全增强方案的情况下，通过遵循最具体的可用路由来工作。苹果宣布 17.0.0.0/9 的路由，这是一个超过 800 万个 IP 的网络。Rostelecom 开始宣布 17.70.96.0/19，这是一个小得多的子网，仅包含 8，000 多个 IP。更具体的路由胜出，并且 Rostelecom 有一个有效的 ASN，因此互联网改变了路由。苹果公司有人注意到了这一点，并推出了 17.70.96.0/21 的路由更新，将可能是最重要的 2046 个 IP 地址移回了正确的目的地。大约 12 小时后，Rostelecom 放弃了伪造的路线。苹果和 Rostelecom 都没有发布关于该事件的声明。

如果这是第一次涉及 Rostelecom 的事件，很自然会得出结论，这是一个诚实的错误。Rostelecom 过去曾表现出不良行为，因此可信的否认因素正在减弱。这可能是针对某人的 iPhone 或苹果账户的有针对性的操作的一部分吗？很难说我们是否会很快知道细节。至少，[你可以看一场网络大屠杀的回放](https://bgpstream.crosswork.cisco.com/event/293915)。

## 电子邮件路由劫持

Cloudflare 正在扩展到电子邮件路由领域，而[研究员【Albert Pedersen】对于](https://albertpedersen.com/blog/hijacking-email-with-cloudflare-email-routing/)没有被邀请进入封闭测试版有点恼火。([测试版现已开放](https://blog.cloudflare.com/email-routing-open-beta/)，如果你需要虚拟邮箱地址的话。)事实证明，您可以使用类似于 Burp Suite 的东西偷偷地“选择加入”测试版——只需在加载仪表板时拦截 Cloudflare API 响应，并设置`"beta": true`。初始仪表板加载后，后端不会检查。虽然访问暂时关闭的测试版不是一个大的安全问题，但这表明可能会发现一些类似的错误。剧透:有。

在您的 Cloudflare 帐户上设置域时，您首先要添加域，然后完成验证所有权的步骤。在此完成之前，它是一个未经验证的域，一个中间状态，在这种状态下，除了完成验证或删除域之外，您不能做任何事情。即使一个域在一个帐户中是完全活跃的，您也可以尝试将其添加到一个不同的帐户中，它将显示为这些待定域中的一个。我们无畏的黑客必须检查，这里有类似的检查丢失吗？如果将电子邮件路由添加到未经验证的域，会发生什么情况？事实证明，在那个时候，它毫无怨言地工作。一个域必须已经在使用 Cloudflare 处理电子邮件，但这个技巧允许拦截所有发往此类域的电子邮件。[Albert] [通过 HackerOne](https://hackerone.com/reports/1419341) 通知了 Cloudflare，并为这一发现获得了便利的 6000 美元。不错！

## 后量子时代，但还是被终结了

NIST 国家标准与技术研究所正在进行一场竞赛，以选择下一代加密算法，目标是建立一套不受量子计算机影响的标准。最近有一个相当明显的提醒，除了抵抗量子算法之外，[一个加密方案还需要抵抗经典攻击](https://arstechnica.com/information-technology/2022/08/sike-once-a-post-quantum-encryption-contender-is-koed-in-nist-smackdown/)。

SIKE 是通过选择过程的算法之一，最近刚刚发表的一篇论文展示了一种在大约一小时内破解该算法的技术。所使用的技术已经为人所知有一段时间了，但这是非常高级的数学，这就是为什么需要这么长时间来演示确切的攻击。虽然密码学家是数学家，但他们通常不在前沿数学领域工作，所以这些意料之外的交互会不时出现。如果没有别的，现在发现这个缺陷是很好的，而不是在新技术被批准和广泛使用之后。

## 位和字节

作为浏览器和走私的结合体，Bruggling 是一种新的数据渗透技术，这种技术愚蠢到足以发挥作用。一些企业网络非常努力地限制用户和恶意应用程序从网络上获取数据并通过互联网发送给坏人的方式。这是一个毫无希望的探索，布鲁格是另一个例子。那是什么呢？Bruggling 是将数据填充到书签的名称和内容中，并让浏览器同步这些书签。由于这看起来像正常的流量，尽管可能是大量的流量，它通常不会像奇怪的 DNS 请求那样触发任何 IDS 系统。到目前为止，Bruggling 只是一个学术概念，还没有在野外观察到，但可能会在你附近出现恶意软件。

LibreOffice 刚刚修补了一些问题，其中有两个问题特别值得注意。第一个是 [CVE-2022-26305](https://www.libreoffice.org/about-us/security/advisories/cve-2022-26305/) ，这是宏签名和验证方式的一个缺陷。宏本身的签名没有被正确检查，通过克隆一个可信宏的序列号和发布者字符串，恶意宏可以绕过正常的过滤器。并且 [CVE-2022-26306](https://www.libreoffice.org/about-us/security/advisories/cve-2022-26306/) 是 LibreOffice 如何存储密码的一个加密弱点。用于加密的初始化向量是一个静态值，而不是为每次安装随机创建的。这种缺陷通常允许预先计算攻击，可以编译查找表，从而快速破解任意加密数据集。在最新版本的 LibreOffice 中，如果使用此功能，将提示用户输入新密码，以便更安全地重新加密其配置。

Samba 还修复了一些问题，其中一个听起来像是好莱坞黑客电影的一个伟大的情节点。第一个是 [CVE-2022-32744](https://www.samba.org/samba/security/CVE-2022-32744.html) ，这是一个逻辑缺陷，其中任何有效密码都被接受用于密码更改请求，而不仅仅是接受被更改帐户的有效密码。 [CVE-2022-32742](https://www.samba.org/samba/security/CVE-2022-32742.html) 是一个有趣的例子，SMB1 连接可以触发缓冲区下溢。本质上，客户机告诉服务器它想打印 10 兆字节，并发送 15 个字节进行打印(数字是为了说明这一点而编造的)。服务器从太小的缓冲区复制数据，并使用攻击者设置的大小值，类似于 [Heartbleed](https://heartbleed.com/) 。我想看那部恶作剧电影，在这部电影中，通过使用这种错误将数据打印到早已被遗忘的换行打印机上，数据被窃取了。

最后， [Atlassian Confluence 安装受到了主动攻击](https://www.rapid7.com/blog/post/2022/07/27/active-exploitation-of-atlassians-questions-for-confluence-app-cve-2022-26138/)，这是一些攻击的结果。在本地融合解决方案中留下了硬编码的凭据，这些凭据在线发布。Servlet 过滤器中的一对关键漏洞在没有有效凭证的情况下就可以被利用。如果您仍在运行未打补丁的、未经优化的 Confluence 安装，那么是时候直接进行遏制和清理了。哎哟！