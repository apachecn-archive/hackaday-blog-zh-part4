# 五岁的臭虫滋生路由器僵尸网络怪物

> 原文：<https://hackaday.com/2018/11/23/five-year-old-bug-spawns-router-botnet-monster/>

新闻报道了又一个路由器僵尸网络。360 网络实验室的[汪卉]和[RootKiter]宣布[他们发现了他们所谓的“BCMUPnP _ Hunter”rootkit](http://blog.netlab.360.com/bcmpupnp_hunter-a-100k-botnet-turns-home-routers-to-email-spammers-en/)。他们估计这个僵尸网络运行在全球超过 100，000 台路由器上。

这个故事中有两个因素让我感到特别困惑。首先，这个僵尸网络利用一个漏洞感染路由器，这个漏洞[在五年前](http://www.defensecode.com/public/DefenseCode_Broadcom_Security_Advisory.pdf)即 2013 年由 Defensecode 首次报告！第二个奇怪的地方是大量易受攻击的设备，它们现在是僵尸网络的一部分。几十个品牌和至少 116 个型号被发现受到感染。

这个故事的一个细节没有被完全准确地报道。Broadcom 芯片组中没有内置该错误。不像 [Spectre 和 Meltdown](http://hackaday.com/2018/01/15/spectre-and-meltdown-how-cache-works/) ，它实际上不是硬件故障。Broadcom 发布了软件开发工具包(SDK ),使 D-Link、TP-Link 和 Linksys 等设备制造商能够使用 Broadcom 芯片快速开发路由器固件。漏洞存在于这段代码中，而不是硬件本身的一部分。

## UPnP 又罢工了！

攻击媒介是通用即插即用(UPnP)协议。这个协议最初是由微软为 Windows ME 开发的。UPnP 的用例是允许本地网络上的一个程序为进入的流量请求一个开放的端口，本质上是自动化端口转发过程。像 bittorrent 这样的点对点流量、在线游戏，甚至像 Skype 这样的电话会议应用程序都需要直接连接到其他用户。随着 ISP 开始只分配单个 IP 地址，NAT 路由器变得越来越流行，需要像 UPnP 这样的解决方案来支持这些对等应用。

虽然这个想法是合理的，但 UPnP 有着传奇般的历史，充满了冒险。2013 年，Rapid7 [发布了一份白皮书](http://blog.rapid7.com/2013/01/29/security-flaws-in-universal-plug-and-play-unplug-dont-play/),着眼于通过互联网访问 UPnP。他们确定了超过 8000 万个响应来自互联网的 UPnP 发现数据包的唯一 IP 地址，其中大约 20%的 IP 暴露了控制端口。UPnP 仅用于内部网络，根据定义，不应被公开发现。这意味着在 2013 年，8000 万台设备正在使用 UPnP 的一个不完整的实现。

## 冬眠多年后

至于为什么僵尸网络只是最近才利用这一特定漏洞，DefenseCode 意识到这可能是一个多么大的问题，特别是在 2013 年该漏洞首次公布时。当时，互联网上估计有 1500 万个易受攻击的设备。DefenseCode 推迟发布攻击的完整细节，直到 2017 年，他们最终选择[发布完整的漏洞细节](http://blog.defensecode.com/2017/04/broadcom-upnp-format-string-preauth.html)。一旦概念验证代码可用，有人创建我们现在看到的自我传播蠕虫只是时间问题。

不难找到包含这一易受攻击代码的 Broadcom SDK 的副本。那个 SDK 的日期是 2007 年，但是基于 2003 年的 Linux 内核，版本 2.4.20。这是业内突出的问题之一。制造商发布了一个基于 Linux 旧分支的 SDK，而不是将芯片组的上游支持引入内核。因为这样“行得通”，所以很少有人急于使用更新的软件，即使旧代码中存在已知的漏洞。这种低质量和过时代码的广泛共享导致了像这样的情况，超过 100 台设备容易受到攻击。

## 从这里去哪里？

在这方面已经取得了一些进展，因为芯片制造商已经开始与上游内核开发人员进行更密切的合作。例如，高通 Atheros 直接与 OpenWrt 合作，提供更高质量的 SDK。芯片组制造商只是解决方案的一部分，因为设备制造商还必须为他们的设备及时发布固件更新。

除了依赖供应商固件更新，我们还有第三方固件的替代方案。OpenWrt 是我最熟悉的发行版，似乎是最好的开源固件替代品。

即使发布了更新的固件，当一切正常时，许多用户也没有兴趣更新他们的路由器。虽然一些制造商已经尝试实现自动固件更新，但这一过程也不是没有问题。值得注意的是，设备已经自动更新到“支持云”的固件，这引入了一类全新的漏洞。

软件漏洞的问题可能永远不会完全消失。我们可以坚持认为像 Broadcom 这样的供应商在代码方面做得更好，但是作为用户，我们对自己的安全负有一定的责任。偶尔检查固件更新，注意开放的端口，并在设备不再维护时更换它们是我们的责任。虽然这个僵尸网络是一个严重破坏的 UPnP 实现的结果，但最终还是要靠你来维护自己的网络。