# 朝日 GPU 黑客

> 原文：<https://hackaday.com/2022/05/16/asahi-gpu-hacking/>

作为 Asahi Linux 工作的一部分，Alyssa Rosenzweig 一直在不知疲倦地对苹果 M1 架构中内置的 GPU 进行逆向工程。如果你不熟悉的话，这个项目是为苹果 M1 产品线增加对 Linux 内核和用户空间的支持。她已经取得了很大的进步，甚至在一年多以前，用她自己的开源代码实现了原始渲染。

然而，[试图让司机成熟却遇到了阻碍](https://rosenzweig.io/blog/asahi-gpu-part-5.html)。对于复杂的渲染，GPU 中的某些东西会中断，帧只是缺少大块的内容。一些聪明的测试发现了确切的失败触发器——太多的总顶点数据。简单地说，它是“顶点的数量(几何复杂性)乘以每个顶点的数据量(“着色”复杂性)。”那…听起来几乎像是缓冲区填满了，但是是在 GPU 本身上。这不是一个驱动程序直接与之交互的缓冲区，所以所有这些搜索都必须盲目地进行。苹果驱动没有像这样的损坏渲染，那么这是怎么回事呢？


[Alyssa]给出了一个关于 GPU 设计的快速速成课程，主要是使用专用内存的桌面 GPU 和使用统一内存的移动 GPU 之间的差异。M1 属于第二类，在构建帧时使用 tilebuffer 来缓存渲染结果。那个 tilebuffer 是固定大小的。溢出会导致帧渲染崩溃。那么司机应该如何处理这件事呢？传统的答案是分配更大的缓冲区，但这不是 M1 的工作方式。相反，当缓冲区填满时，GPU 会触发部分渲染，这会吃掉缓冲区中的数据。问题是，部分渲染被发送到屏幕上，而不是与渲染的其余部分正确混合。为什么？回到捕捉苹果驱动使用的命令。

驱动程序做了一些奇怪的事情，它设置了两个独立的加载和存储程序。知道渲染缓冲区会在渲染中间移动，这就开始有意义了。一个函数用于部分渲染，另一个函数用于最终渲染。忽略设置其中的一个，当 GPU 需要缺少的函数时，它会取消引用一个空指针，呈现会爆炸。因此，提供缺少的函数，获得正确的配置，渲染就正确完成了。终于！胜利从来没有这么甜蜜过，就像是在追捕到一只像这样神秘的虫子之后。

生活中需要更多朝日 Linux？就在上周，[Hector Martin]接受了《FLOSS Weekly 》的采访，向我们简要介绍了这个项目。