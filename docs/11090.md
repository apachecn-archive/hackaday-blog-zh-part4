# 本周安全:破解苹果 ID、政治黑客主义和空中追踪

> 原文:[https://hackaday . com/2021/08/20/this-week-in-security-breaking-apple-id-political-hacktivism-and-air tag-tracking/](https://hackaday.com/2021/08/20/this-week-in-security-breaking-apple-id-political-hacktivism-and-airtag-tracking/)

您是否考虑过单点登录(SSO)实现的所有复杂性？大量的工程努力已经加强了对跨站点攻击的防御——你不会希望你访问的每个站点都能劫持你的谷歌或脸书账户。同时，SSO 是一种有用的能力，可以在一个服务上使用您的身份验证来对一个不相关的站点进行身份验证。SSO 会损害这种硬化吗？如果出现错误，绝对是[正如【Zemnmez】在查看 Apple ID SSO 系统](https://zemnmez.medium.com/how-to-hack-apple-id-f3cc9b483a41)时发现的那样。

这一切都始于观察到`icloud.com`有一个与`apple.com`对话的登录，两个独立的域。用来实现这一点的卑鄙伎俩是在`icloud.com`网站中嵌入苹果登录页面的 iframe。有几个安全措施，旨在防止滥用该嵌入式网站。首先必须克服的是 Oauth2 `redirect_uri`用于检查白名单域，以及为`content-security-policy`头设置允许的域。简单地说，攻击必须设置一个单独的字符串，这个字符串看起来是 Oauth2 后端的`icloud.com`，但却是检查安全策略头的浏览器的`OurEvilSite.com`。这种看似不可能的脚是怎么做到的？通过滥用 URI 编码固有的极度灵活性。`[https://OurEvilSite.com;@icloud.com](https://OurEvilSite.com;@icloud.com)`两种不同的安全机制对它有不同的理解，允许嵌入。

下一个要解决的问题是，嵌入式 iframe 与`icloud.com`页面来回传递消息，如果握手没有完成，什么都不会发生。这个握手很容易被欺骗，除了一个小细节。基于相同的`redirect_uri`，再次指定域。这里的技巧是要意识到这个 URI 在页面加载过程中的不同时间点通过`decodeURIComponent`函数两次。对一个问号字符进行双重编码允许使用额外的欺骗手段，控制安全检查所看到的内容。

要克服的最后一个障碍是消息来源检查，这是一个类似的安全特性。这不是巧妙的解析器攻击，而是通过另一个漏洞来克服。如果消息源为空，则不会进行这种检查。实现这一目标的方法是什么？关闭`allow-same-origin`标志。这创建了一个 iframe，它与页面的其余部分部分隔离。听起来没用？解决方案是在攻击者页面中嵌入两个 iframe，并通过有权限这样做的框架传递消息。通过这种疯狂的组合，攻击者可以成功地在自己的页面上嵌入`apple.com`登录小部件。

我知道你在想什么。那又怎样？只需从 iframe 中提取 HTML、CSS 和图像，您就可以毫不费力地自己复制它。又一个漏洞让这次攻击变得令人印象深刻。要理解它，你首先需要理解 HTML 模板的[手柄](https://handlebarsjs.com/) JavaScript 库。这个库允许你编写你的页面模板，并包含`{{someObject}}`表达式。然后运行模板，指定表达式调用的数据。apple.com SSO 页面使用这个库来显示来自调用页面的定制信息，比如隐私信息等。

车把库有一个特殊类型的表达式`{{{the triple handlebar}}}`，允许不安全的 HTML 插入。把它们放在一起，你可以创建一个有效的“登录苹果”按钮，将用户重定向到苹果的`idmsa.apple.com`页面，但是在该页面上注入任意代码。查看下面的商品演示。

 [https://www.youtube.com/embed/foZlfnDeULE?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent](https://www.youtube.com/embed/foZlfnDeULE?version=3&rel=1&showsearch=0&showinfo=1&iv_load_policy=1&fs=1&hl=en-US&autohide=2&wmode=transparent)

T2】

## 黑客行动主义和伊朗

![Desktop hung at boot, displaying message in Arabic. ](../Images/c021bc9aa0fdf4cc271356c42086f1d9.png)

“We attacked the computer systems of the Railway Company and the Ministry of Roads and Urban Development”

检查站研究为我们带来了一份关于最近针对伊朗交通基础设施的网络攻击的报告。该攻击使用 Active Directory 将有效载荷部署到连接的计算机上，这些计算机被擦除，然后被修改为在启动时挂起，显示来自攻击者的消息。目标似乎是破坏运输系统，雨刷程序中有一个聪明的例外。带有少量包含“PIS”的主机名的机器会被自动跳过。这个缩写代表“乘客信息系统”——显示状态和延误的大型数字广告牌。攻击者希望等待的乘客能够确切地看到系统受到的影响有多严重。

Checkpoint 认为这与之前针对伊朗的袭击以及针对叙利亚目标的两起事件是同一伙人所为。这个自称的名字叫因陀罗，以一个印度教战神的名字命名。对于我们这些不了解印度教神学的人来说，因陀罗可以被认为是一个类似于托尔的人物。该组织声称自己本质上是反对伊朗及其对恐怖组织资助的黑客行动主义者。虽然因陀罗没有声称对最近的攻击负责，但 Checkpoint 做了很好的工作，证明他们正在使用相同的攻击。

## CVE·斯卢丁—和 Perl 怪癖

来自 Atredis 的[Justin Kennedy]正在进行红队演习，[他遇到了 Sophos UTM9 威胁管理设备](https://www.atredis.com/blog/2021/8/18/sophos-utm-cve-2020-25223)。此特定安装尚未更新，以缓解 CVE-2020-25223，预授权 RCE。对于演示针对客户端的攻击来说，这是一个很大的突破，但是有一个小问题。这 CVE 从未得到充分披露，似乎没有人有剥削的细节。他拿起一对安装 iso，运行易受攻击和打了补丁的设备的虚拟化实例。在某些系统上，对两个版本进行区分是很容易的，但是它们使用了一些技巧来混淆代码。首先，Perl 被编译成`plx`二进制文件。这可以通过使用调试器，并从内存中复制去模糊的脚本来解决。第二个问题是完成繁重工作的 Perl 模块不是恢复代码的一部分。Atredis 的一位工程师同事发现，所需的模块实际上隐藏在 BFS 文件系统中，附加在 web 服务器`plx`的末尾。现在有了原始的 Perl 源代码，他就可以开始工作了。

代码本身有一个变化，在`asg_connector.pm`中添加了 Perl regex，它检查传入的 SID(会话 ID ),并可能将其作为无效内容丢弃。现在，Perl regex 以笨拙和难以被人类解析而闻名。这就是一个例子。
`if ($sid =~ m/[^a-zA-Z0-9]/) { #SID is invalid .... }`
【贾斯汀】看了看这个，心想:‘哦，这是根火柴串，在找字母数字。它以插入符号开头，这意味着它只检查字符串的第一个字符。我知道这大概是他的思考过程，因为他写道，“更新的代码显示一个检查被添加到`switch_session`子例程，确保 SID(会话 ID)不以任何字母数字字符开头。”在他的辩护中，他接受了这个提示，并研究了如何滥用传入连接上的 SID 值作为可能的漏洞，但这不是 regex 所做的。

这值得[快速进入 Perl 正则表达式](https://perldoc.perl.org/perlre)来解释。`=~ m/MyRegex/`结构是匹配操作符，如果它所作用的字符串包含模式描述的文本，则返回 true。带括号的字符类是描述这些模式的一种方式。所以`[a-z]`将匹配一个小写字母字符。您可以将它们组合起来，就像 Sophos 代码中所做的那样:`[a-zA-Z0-9]`将匹配任何大写或小写字母数字字符。那么脱字符号“^”呢，它是做什么的？这里我们看到了复杂性。通常，Perl 正则表达式中的插入符号代表一行的开始。这将与以字母数字开头的 SID 相匹配。然而，当插入符号在括号内时，它有完全不同的效果。在这种情况下，它可以反转选择。综上所述，上面的正则表达式实际上是在检查除简单字母数字以外的任何字符，如果发现它们，就将 SID 标记为无效。Regex 有时候很难。

除此之外，包含特殊字符的 SID 会造成什么危害呢？要回答这个问题，我们必须深入研究代码，看看它在哪里被使用。Sophos 系统以每个有效 SID 的名称在设备文件系统上创建一个文件，并在一个新的连接上，尝试用 Perl `open()`调用读取该文件。我听到你在呻吟，又一个 Perlism。是的。Perl 有一个非常方便的机制，您可以通过管道与系统上的另一个命令进行交互。看起来有点像`open(Handle, "netstat -i -n |")` Perl 将进行系统调用，并为您收集输出，就像您从文件中读取它一样。这非常方便，但是如果最终用户可以控制文件名——就像本例中的 SID 一样——就会出现可怕的安全问题。

我们的主角发现了这一点，心花怒放！他已经找到了漏洞！他试过了…但是没用。管道符号被删除，他的 SID 被奇怪地改变了。但是等一下，虽然代码本身有一个变化，但是配置文件 Apache `vhost` config 也有变化。带有漏洞修复的版本删除了一些设置，最明显的是删除管道符号的输入过滤器。他工作了一段时间，试图在`sed`弦上找到一个洞，但没有成功。然后答案变得显而易见:有一个重写规则，允许请求被发送到`/var`，它会跳过过滤器，重新路由到 webadmin 端点。那就是预授权的 RCE。只需向设备上的`/var`发出请求，并将 SID 设置为`| touch /tmp/pwned`。

## T-Mobile 漏洞

T-Mobile 遭遇了另一次巨大的数据泄露。4000 万客户的姓名、出生日期、社会保险号和驾照信息——所有在 T-Mobile 申请信用卡的人。此外，大约 860 万当前客户的数据也受到了某种程度的损害。如果您是 T-Mobile 的客户，请小心针对您和您的帐户的诈骗和欺诈。到目前为止，除了标准的官方声明称这是一次“高度复杂的网络攻击”之外，还不太清楚这次入侵是如何发生的。

## QNX Baddalloc

QNX 嵌入式操作系统最近出现了一系列漏洞[。这个由黑莓开发的 Unix 系统可能不是你熟悉的系统之一，但它出现在我们周围的相当多的设备中。举个例子，](https://www.bleepingcomputer.com/news/security/cisa-badalloc-impacts-critical-infrastructure-using-blackberry-qnx/) [Driverack PA2 扬声器管理系统](https://dbxpro.com/en/products/driverack-pa2)运行的是 QNX 的旧版本。(一个旧版本碰巧通过调试端口拥有自己的预授权 RCE，但这是另一个时代的另一个故事)QNX 最令人担忧的地方是在运输和医疗工作负载中。作为一个真正的实时操作系统，它是一些时间关键型工作负载的良好候选，这也是 CISA 发出警告的原因。

## 安全气囊伸张正义

最后，一个振奋人心的故事，一辆被盗的电动滑板车通过技术被找回。当他的车被偷时，他不是普通的受害者。他提前在里面藏了一对苹果航空标签。果然，他通过苹果系统获得了一个 ping，知道了被盗设备的位置。他联系了警方，并试图说服他们帮助他找回它，但遇到了可以理解的阻力。

航空标签是新的，警察和我们一样是诈骗的目标。在黑帽休息了一会儿后，他回到警察局，试图再次寻求官方的帮助。这需要一个关于空中标签的速成班和一些熟练的说服，但他确实设法找到了一个陪同人员，去寻找踏板车的指示位置。二手电动自行车商店似乎是一个明显的起点，当他走进门时，他的手机直接链接到他的 Airtag。他能够证明所有权，并把他的摩托车带回家。

> 我的摩托车上周被偷了。小偷不知道，我藏了两个航空标签在里面。我今天能够使用苹果查找我的网络和超宽带测向来恢复滑板车。事情是这样的:
> 
> —丹圭多(@ d Guido)[2021 年 8 月 10 日](https://twitter.com/dguido/status/1424921645483966466?ref_src=twsrc%5Etfw)