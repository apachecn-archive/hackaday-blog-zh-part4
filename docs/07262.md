# Linux-Fu:你自己的动态域名系统

> 原文:[https://hack aday . com/2020/08/25/Linux-fu-your-own-dynamic-DNS/](https://hackaday.com/2020/08/25/linux-fu-your-own-dynamic-dns/)

这是一个和互联网一样古老的问题。你想远程访问你的电脑，但是它在一个随机获取不同 IP 地址的路由器后面。或者可能是您的笔记本电脑，它在不同的位置使用不同的 IP 地址。有许多方法可以解决这个问题，其中一些比其他的更好。

许多路由器可以向动态 DNS 服务器报告它们的 IP 地址。这曾经很棒，但现在看起来他们中的许多人都在催促你升级或不断更新，这样你就可以看到他们的广告了。其中一些也消失了。如果你的路由器供应商提供一个，这可能是一个不错的选择，当然，除非你更换路由器。OpenWRT 支持[许多这样的服务](https://openwrt.org/docs/guide-user/services/ddns/client)并且有许多[公共服务的列表](https://gist.github.com/neu5ron/860c158180e01b61a524)。

然而，如果你有一台公共可访问的计算机，例如一个 Web 服务器或者甚至一个云实例，并且你运行你自己的 DNS 服务器，你真的不需要这些服务。我将向您展示我是如何使用运行`Bind`的可访问的 Linux 服务器来实现的。这是一个常见的设置，但是如果你有一个不同的系统，你可能需要做一些调整。

如果你愿意在双方都有大量的结构，有许多方法可以[建立动态 DNS](https://wiki.debian.org/DDNS) 。其中大部分依赖于设置一个秘密密钥来允许 DNS 更新和某种调用`nsupdate`的脚本，或者让 DHCP 服务器来完成。问题是，我有很多客户端计算机，而且很多设置都不一样。我想要一个客户端唯一需要的东西是`ssh`的系统。所有的基础设施都保留在 DNS 服务器上。

## 背景

我将假设您已经有了`Bind`设置，并且对 DNS 的工作有所了解。不过，一般来说，您控制的每个域(DNS 术语中的区域)都有一个单独的文件。下面是一个典型的区域文件( [RFC 1035](https://tools.ietf.org/html/rfc1035) 控制格式):

```
; zone file for wd5gnr.com
$TTL 3600 ; default TTL for zone
$ORIGIN wd5gnr.com.
@ 3600 IN SOA ns1.wd5gnr.com. alw.al-williams.com. (
12040320 ; serial number
3m ; refresh
180 ; retry
1209600 ; expire
3m ; negative
)
@ IN A 158.69.212.64
@ IN NS ns1
@ IN NS ns2
ns1 IN A 158.69.212.64
ns2 IN A 158.69.212.64
@ IN MX 10 mail
www IN A 158.69.212.64
```

这里感兴趣的部分是生存的时间。该值以秒为单位，因此这是一个小时。如果你的 IP 地址变化很大，那么等待的时间可能会有点长。还有一个序列号，服务器用它来告知记录已更改。数字没有真正的格式，只要每次变化都会产生一个更大的数字。您可以使用顺序计数器或改变日期。这其实并不重要。最后，IN 记录告诉我们不同的 IP 地址。对于这个文件来说，`@`是`wd5gnr.com`的简写，任何结尾没有句点的内容都将被追加`wd5gnr.com`。因此，最后一行定义了一个主机“www.wd5gnr.com”，可以写成“www.wd5gnr.com”，而不是“www”——最后一个句点造成了所有的差异。

[![](../Images/dcf2601628dc7d845f05e1615a4ba5ec.png)T2】](https://hackaday.com/wp-content/uploads/2020/07/dns-1.png)

不知何故，我们需要一种方法在这个区域文件中创建更多的记录，将其他主机(可能是`dyn.wd5gnr.com`)指向不同的 IP 地址。我从 DNS 服务器上的一个非常简单的脚本开始，它将找到调用者的 IP 地址，并修改一个模板来创建一个 DNS 区域文件，然后重新加载该区域。这种方法一直有效，直到我想同时处理多个动态主机。我将向您展示我是如何处理的，但首先，让我们谈谈您自己需要做些什么。

## 你需要什么

除了您控制的域的 DNS 服务器之外，您还需要对您的服务器进行 ssh 访问，以使用证书而不是密码。您可能也需要 root 访问权限，尽管我会向您展示在设置后您如何不需要它，如果您不介意允许任何人登录您的帐户来更新您的 IP 地址的话。

设置`ssh`到[不需要密码](https://www.ssh.com/ssh/copy-id)很简单，强烈推荐。如果你需要一本关于设置`Bind`的入门书，你可以阅读[这篇文章](https://linuxtechlab.com/configuring-dns-server-using-bind/)，只要你记得用你的包管理器代替`yum`——除非你的包管理器是`yum`！或者你可能更喜欢这个。

## 这个计划

一旦你设置好了 DNS 服务器和一个`ssh`会话，就只需要设置一些东西了。

1.  使用`ssh`远程运行的脚本。
2.  定义您的 DNS 区域文件(但不是您的 DNS 区域文件)的模板。
3.  一种从本地机器触发脚本的方法。
4.  一种重新加载 DNS 服务器的方法。

当然，这个脚本是一个 Bash 脚本，但是它很好地利用了 Awk。我最初的模板文件格式很简单。我复制了区域文件，用`$SERIAL`替换序列号，用`$IP`替换动态 IP 地址。该脚本将插入新值，并使用一个名为`rndc`的控制程序重新加载 DNS 服务器，一分钟内即可完成。

## 几个问题

这种方案的最大问题是只允许一个动态 IP 地址。但是在我们解决这个问题之前，让我们先来看一些问题。首先，我们需要了解调用脚本的计算机的远程地址。下面是一些代码:

```
echo "$SSH_CLIENT" | cut -d ' ' -f 1
```

当然，这是假设我们通过`ssh`登录的。我走了一些捷径，因为除了在测试期间，我不希望手动调用这个脚本。论点很简单，尽管我后来不得不补充一点。第一个脚本用一个 IP 地址或破折号来表示我的`ssh` IP 地址，一个区域名，仅此而已。

该脚本将在当前目录中查找`${ZONENAME}.dns.template`，并使用一个简单的`awk`脚本来`gsub`模板中出现的`$SERIAL`和`$IP`。`Awk`会写入一个临时文件，一旦成功，我会将文件转移到 DNS 文件(同样，在同一个目录中)并更新服务器。

最后一点也有点棘手。`Bind`有一个工具`rndc`，可以重新加载一个区域(除了别的以外)。但是通常你必须是根用户才能运行它。当然，你可以使用`sudo`，但是对于自动脚本来说，这并不方便，因为它会需要你的密码。

## 修改 SUDOERS

原来`sudo`有很多你不常用的功能。其中一个将允许用户或用户组在没有密码的情况下执行操作，即使它通常需要 root 用户。显然，你需要非常小心地使用这种能力。我在 DNS 服务器上创建了一个名为`/etc/sudoers.d/91-dynamicdns`的文件，其中只有一行:

```
myuserid    ALL=(root) NOPASSWD:   /usr/sbin/rndc reload wd5gnr.com
```

这允许我以普通用户的身份重新加载该区域文件，而无需使用`sudo`输入密码。如果您尝试做其他事情，您仍然会得到`sudo`密码提示。

[![](../Images/238928d570bff43791bd0291b016444f.png)T2】](https://hackaday.com/wp-content/uploads/2020/07/incident.png)

XKCD by【兰道尔·门罗】 [CC By_NC 2.5](https://creativecommons.org/licenses/by-nc/2.5/)

## 调用脚本

剩下的就是使用`ssh`调用本地机器上的脚本。你有几个选择。当然，手动运行它很容易，但是我使用了`cron`或`anacron`来定期调度脚本的执行，并与 TTL 值大致同步。如果你愿意，你可以使用`systemd`。在使用`NetworkManager`的笔记本电脑上，可以编写一个在网络连接时运行的脚本，这可能是合适的。

具体如何做将取决于您的设置。请记住，即使一旦 WiFi 连接，路由器也可以随时获得新的 WAN IP 地址，因此，即使您想在网络连接或登录时强制更新，某种定期更新可能也是一个好主意。

## 多个主机

这一切在一段时间内运行良好，但我最终希望允许多行。问题在于，每一次更新都与其他更新脱节。不知何故，您希望模板只影响需要更改的特定行。我还想检查 IP 地址，只有在新的 IP 地址不同的情况下才重新加载。

![](../Images/5f2a284ef6470f2dfc1cc9e0ecc56b68.png) 这个问题当然有很多解决方法。甚至有可能将 IP 地址存储在数据库或文件中，然后每次都进行更新。但是那看起来很痛苦，所以我选择了更简单的方法。模板文件现在会将任何不带前缀的行原封不动地复制到输出中。但是有些行会有一个前缀，前缀是文本，后跟一个冒号。当脚本找到这样一行时，它会查看前缀是否是我们正在使用的那个。如果是，则像以前一样替换`$SERIAL`和`$IP`。它去掉前缀并暂时隐藏该行。有一个特殊的前缀`!`，可以匹配任何前缀。这主要是为了让`$SERIAL`可以用在每次更新都会改变的一行中。

使用这种新方案，脚本在处理模板时不会产生任何输出。但是，该脚本现在接受两个参数:模板和现有的区域文件。对第二个文件的处理是不同的。它只是将区域文件中的每一行复制到一个新文件中，除非第一遍中有替换行。如果有，该行将替换旧行。您可以通过查看告诉您当前正在处理哪个文件的`ARGIND`来确定`awk`处于哪个阶段。

那么，唯一的大问题是，你是否试图同时运行脚本两次。这个问题的答案是使用`flock`，一个早期的 Linux-Fu 中的[技术。](https://wp.me/paBn4l-1MaX)

你可以在 [GitHub](https://github.com/wd5gnr/sshddns) 上找到完整的最终脚本以及一个示例模板文件。注意，一切都在服务器上运行。您只需通过`ssh`运行脚本即可——这可以通过多种方式自动完成——剩下的工作由服务器端的代码完成。因为你可能无论如何都需要设置`ssh`,这意味着没有额外的键需要维护，也不需要在你想修改任何东西的时候对每个客户端进行更新。

## 其他方法

像往常一样，有许多方法可以解决这个问题。这可能适合也可能不适合你的需要。我考虑使用`$INCLUDE`编写模板，为每个动态主机包含一个子区域文件，并让脚本编写这些文件。这可能会工作，但如果你有很多主机，它会有很多零散的文件。关于`$INCLUDE`的正确行为，RFC 1035 中也有一些模糊之处，尽管 Bind 文档澄清了这一点，至少就 Bind 而言是这样的。

不过，它仍然展示了一些关于`awk`和`flock`的有趣技巧。还有其他方法可以找到你的远程服务器，比如 [PageKite](https://hackaday.com/tag/how-to-use-pagekite/) 。最后，你可以把[硬件扔向问题](https://hackaday.com/2011/04/12/dynamic-dns-updating-no-pc-required/)。