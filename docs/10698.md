# Linux Fu:凡人的超能力

> 原文:[https://hack aday . com/2021/07/26/Linux-fu-super powers-for-mere-mere-凡人/](https://hackaday.com/2021/07/26/linux-fu-superpowers-for-mere-mortals/)

提到`sudo`命令，你很难不想起关于制作三明治的搞笑 XKCD 漫画。看起来`sudo`的确是让 Linux 系统做你想做的事情的神奇力量。唯一的问题是，那些超级大国不是可以掉以轻心的东西。

[![](../Images/3621d9d5e2eec6b7a8643454a8f5a78a.png)](https://hackaday.com/wp-content/uploads/2021/07/sandwich.png)

[CC-BY-NC-2.5](http://creativecommons.org/licenses/by-nc/2.5/)BY【XKCD】

例如，如果你在网上冲浪，你真的不想成为超级用户，因为如果有人恶意接管你的计算机，他们可以用你的超级用户密码做更多的伤害。但是，有时您想运行某些命令，而这些命令通常只允许 root 用户使用，并且不需要密码。幸运是，`sudo`可以非常容易地处理用例。

## 为什么？

举个简单的例子，假设你喜欢在一天结束时关闭电脑。您从终端运行 shutdown 命令，但它不起作用，因为您不是 root 用户。然后，您必须使用`sudo`再次登录，如果您最近没有登录，请提供您的密码。呃。

在我的例子中，当我需要在启动脚本中操作`dbus`服务时，我开始考虑这个问题。我希望脚本像普通用户一样操作该服务，而不提示输入密码，特别是因为有些用户根本没有`sudo`权限。无论哪种方式，您都希望有一种方式让普通用户运行非常具体的命令，而无需额外的权限。

## 一个简单但糟糕的方法

您的第一个想法可能是将代码包装在 root 拥有的 shell 脚本中，并设置`suid`位，这样当您执行它时，脚本就提升为具有 root 访问权限。这将工作，但它似乎是一个潜在的安全问题。毕竟，脚本可以做任何事情。你确定一个用户没有办法强迫它做别的事情吗？你真的确定吗？

当然，你总是要考虑这一点。比如说，如果你允许某人以 root 用户身份运行`emacs`，那么这个人就可以打开一个 shell，并且拥有对系统的完全访问权限，即使他们没有 root 用户权限。这可不好。但是通常更容易推理出具有特定功能的程序，而不是通用的 shell 脚本。

## 配置

[![](../Images/19cdb938c6a72d43746666d49c2c6563.png)](https://hackaday.com/wp-content/uploads/2021/07/sudo2.png) 这就是`sudo`的用武之地。实际上只有一个地方可以设置`sudo`，尽管大多数现代发行版都有一个地方可以从另一个地方读取文件，您也可以使用这个地方。主要位置是`/etc/sudoers`，正如您所猜测的，您需要以 root 用户身份来更改该文件。事实上，你根本不应该用普通编辑器打开它。使用`visudo`来验证你不会因为弄乱这个文件而把自己锁在根访问之外。这对于无法以 root 用户身份直接登录的系统来说非常糟糕。

当您使用`visudo`时，会启动一个编辑器。如今，默认情况下通常是`nano`，尽管从名字可以看出`vi`是历史性的选择。如果你喜欢别的东西，这个工具会选择你的`VISUAL`或`EDITOR`环境变量。嗯……算是吧。

《T0》和《T1》的作者是偏执狂，这是理所当然的。可以选择在运行命令之前删除所有环境变量，或者只保留选定的环境变量。所以大多数时候，如果你试图设置这些环境变量中的一个，它就会被`sudo`清除掉。为了解决这个问题，你必须使用默认的编辑器。您可以保留环境变量并提供一个可接受的编辑器列表，方法是将它放在文件顶部附近:

```
Defaults env_reset
Defaults env_keep=VISUAL
Defaults env_keep=EDITOR
Defaults editor=/usr/bin/nano:/usr/bin/emacs:/usr/bin/vi
```

请记住，您的`DISPLAY`变量也不会通过，所以不要期望 GUI 编辑器在没有进一步配置更改的情况下工作。

如果`visudo`因为语法错误而不喜欢你的修改，它会问你该怎么做。按下`?`查看您的选项。反正你可以告诉它保存，但我不建议这样做。

## 现在怎么办？

[![](../Images/4bd12e970a617bb91feae6b669c0fbd0.png)](https://hackaday.com/wp-content/uploads/2017/03/tux-on-htop-thumb.jpg) 你可以在`sudoers`中输入许多神秘的语法命令来获得不同的效果。在这种情况下，我们希望在没有特定用户密码的情况下运行类似于`shutdown`或`service`的命令。假设用户是 jolly _ wrencher:

```
jolly_wrencher ALL= NOPASSWD: /usr/sbin/shutdown
```

这告诉`sudo`所有机器上的用户无需密码就可以运行该命令。如果命令带有参数，用户可以自由地提供它们。但是，您也可以提供必须匹配的参数，或者使用带引号的空格来暗示不允许任何参数。

在不允许的情况下，如果您提供了密码并且您被允许运行该命令，`sudo`可能仍然允许您运行该命令。否则，没戏。

例如，在`dbus`示例中，我使用了两行代码:

```
jolly_wrencher ALL= NOPASSWD: /usr/sbin/service dbus status
jolly_wrencher ALL= NOPASSWD: /usr/sbin/service dbus --full-restart
```

## 更容易维护

许多发行版现在会在`sudoers`文件中有一个类似这样的最后一行:

```
#includedir /etc/sudoers.d
```

这将扫描名为的目录中的文件(除非它们有~或。名称中的字符)并处理它们。所以在我的例子中，我在文件`/etc/sudoers.d/dbus-service`中有关于`dbus`的两行。你还是应该用`visudo`来编辑。在最近的版本中，您只需传递您想要编辑的文件的名称。旧版本需要一个`-f`选项。编辑后，系统会检查整个`sudoers`文件是否有错误，因此比直接编辑文件更安全。

使用`sudo`和`sudoers`可以做更多的事情。然而，你应该抵制做太多的冲动。人们很容易对安全性做出假设，从而给自己带来麻烦。然而，总有一些情况下你需要这种能力，像往常一样，Linux 不会让人失望。