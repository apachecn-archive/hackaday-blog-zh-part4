# 本周安全:我的 TLS 中的浣熊，绕过前端，和默默无闻

> 原文：<https://hackaday.com/2020/09/11/security-this-week-racoons-in-my-tls-bypassing-frontends-and-obscurity/>

[浣熊](https://raccoon-attack.com/)是下一个华而不实的安全漏洞，有名字、可爱的标志和网站([和 PDF](https://raccoon-attack.com/RacoonAttack.pdf) )。浣熊是 TLS 1.3 之前版本中的一个缺陷，看起来是一个巧妙的工作，尽管它在现实世界中的应用有限。核心问题是，当使用 Diffie Hellman (DH)，[时，这些旧版本的 TLS 会在生成的预主密钥](https://tools.ietf.org/html/rfc5246#section-8.1.2)中丢弃前导全零字节。因为该密钥是用于计算主会话密钥的输入的一部分，所以缩短的预主密钥导致主密钥的计算稍微更快。如果攻击者可以进行细粒度的计时测量，他就可以确定预主密钥何时被修整。

我们来简单回顾一下[迪菲·赫尔曼](https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange#Cryptographic_explanation)。客户端和服务器同意两个数值，一个基数`g`和模数`p`，每一方生成一个密钥`a`和`b`。每一方通过将共享基数提升到他们自己的私钥来计算公钥，mod 共享模数:`A = g^a mod p`。交换这些公钥，每一方将收到的密钥提升为自己的密钥:`A^b`。指数有一个不明显的怪癖，即幂律。一个值的幂次幂次等于该值的指数幂次相乘。`g^a^b`等于`g^(a*b)`。通过这种数学舞蹈，服务器和客户机达到了一个只有它们自己知道的共享值，同时保持了它们私钥的保密性。

这种攻击只有在服务器为多个连接重用其 DH 密钥时才会被利用。该攻击是为了捕获目标客户端的公共 DH 密钥，该密钥作为 TLS 握手的一部分以明文形式发送。攻击者现在发起一个新的 TLS 握手，但是为自己的公钥选择了一个特殊的值:目标的公钥，它的指数是随机的，但是是已知的。请注意，这意味着攻击者实际上无法计算新的共享密钥，但可以了解一些相关信息。通过仔细测量服务器的响应时间，可以确定这个新的 DH 共享密钥是否有一个前导零字节。这本身并不十分有用，但是有一个数学技巧改变了这个游戏，即[隐藏数字问题](https://crypto.stanford.edu/~dabo/pubs/abstracts/dhmsb.html)。

隐藏数字问题(HNP)是一种破解像 DH 这样的公钥密码的方法。所涉及的数学问题超出了我的能力范围，但我们至少会试着得到一个概观。在 DH 交换中，模运算符用于保持数字的大小易于管理。有一个副作用——通常一维的数字线可以被认为是二维的数字网格。有一些聪明的算法在 2D 点阵上工作，但在普通数轴上不工作。结果是，当你有足够的关于你要找的隐藏数字的线索时，找到那个数字会变得容易得多。

HNP 的一个出人意料的结论是，并非所有的比特都同等重要。当试图求解 HNP 时，知道最高有效位(msb)更有用。换个说法，知道一个数在一千到五千之间，比知道它是偶数更有用。信息泄漏揭示了最重要的字节，这一事实意味着它比仅仅将密钥长度缩短 8 位要有用得多。

在发现新密钥以零字节开始的多种情况后，HNP 解决方案是可行的，并且可以计算受害者的会话密钥。有了这个密钥，整个会话都可以被解密。

浣熊不难减轻。在服务器端，不要重复使用 DH 密钥。这被认为是最佳实践，大多数发行版和设备都默认采用这种配置。在客户端，在 TLS 握手中放弃对 Diffie Hellman 密钥交换的支持也缓解了这个问题。所有主要的 web 浏览器都已经淘汰了这些旧模式，但是在未来的几年里，不可避免地会有对库和应用程序的支持。使这一切成为可能的时序侧通道需要非常严格的测量容差，因此在现实世界中很难实际使用浣熊。

有些情况下浣熊更容易搞定。F5 BIG-IP 设备的某些配置[有一个特殊的缺陷，使得零字节的检测更加容易](https://support.f5.com/csp/article/K91158923)。该报告指出，还有其他具有类似缺陷的实现，可能正在报告和修复过程中。

## TLS 完成

接下来是另一个 TLS 攻击，但是这个完全是 wolfSSL 客户端中的一个漏洞。该报告将该问题描述为 TLS 1.3 状态机没有被严格执行。更简单地说，wolfSSL 在验证证书的过程中接受“完成”消息。攻击者可以成功地中间人攻击 TLS 连接。版本 4.5.0 已经发布，解决了这个问题。

## h2c 请求走私

许多 web 服务使用 Nginx 实例作为反向代理和负载平衡的架构。Nginx 经常终止 TLS，并提供安全性和用户认证。在这种安排中，最终用户并不打算直接连接到后端服务器。绕过这种隔离的方法通常会带来意想不到的安全问题。Bishop Fox 实验室的[杰克·米勒]做了一些有趣的工作，使用 HTTP/2 over cleartext (h2c)作为一种新的方式来完成 HTTP 请求走私。我们在过去已经讨论过一些关于 [HTTP 请求走私的问题。](https://hackaday.com/2020/03/20/this-week-in-security-working-from-home-edition/#http_desync)

这里的技巧是，可以请求将连接从 HTTP/1.1 直接升级到 h2c 连接。这通常使用 TLS-ALPN 来完成，这是一个专门为管理允许的协议而设计的 TLS 扩展。HTTP/2 [规范不允许](https://tools.ietf.org/html/rfc7540#section-3.2.1)在常规 TLS 连接中发送升级请求，但似乎一些前端错误地允许将请求转发到后端。如果受保护的 HTTP 服务器允许连接升级，前端将忠实地将该连接视为未受管理的隧道，绕过前端服务中内置的任何保护。

## SSH 蜜罐

一个开放的 SSH 服务在三个月内会吸引多少次登录尝试？[多亏了【大卫·托马希克】](https://systemoverlord.com/2020/09/04/lessons-learned-from-ssh-credential-honeypots.html)，我们可以有把握地说已经超过九(十万)了！对登录尝试的分析证明是有趣的，显示了一系列默认的和经常使用的用户名/密码组合。有一个密码特别引起了我的注意，`J5cmmu=Kyf0-br8CsW`。除了通常猜测的密码列表之外，这似乎不会出现在任何地方。我立即怀疑这是否是对某个模糊系统起作用的注入攻击。[David]询问关于这个密码猜测的信息，如果有人知道它来自哪里，我会回应这种好奇。

## 通过模糊获得安全感

终于在本周，【Utku Sen】的一篇文章引起了我对[通过模糊获得安全的优点](https://utkusen.com/blog/security-by-obscurity-is-underrated.html)的注意。这是一个谈论这个有争议的话题的好机会，但是如果你有时间，先去读这篇文章。他的观点本质上是，晦涩是深度防御策略的一个有用组成部分。只要你小心谨慎，这并不是一个可怕的想法，但有一些警告。

在某种程度上，几乎所有的安全都是通过默默无闻实现的。您的密码是安全的，因为它很隐蔽，不会出现在常用密码列表中。你的 4096 位密钥够隐晦，在宇宙热寂之前不会被猜到。除此之外，像移动 SSH 端口这样的事情有助于减少日志噪音。禁用根 SSH 登录会迫使攻击者猜测帐户名和密码，这实际上增加了密钥长度。

但实际上，当我们通过模糊性来消极地谈论安全性时，这两种情况都不是我们所谈论的。这个短语通常指易受攻击的软件，或者非常糟糕的政策，我们认为它们永远不会受到攻击，因为它们不会被注意到，就像在公司网站上运行一个超级旧版本的 WordPress，不要担心它，因为几乎没有人访问它。一个特别麻烦的例子是，某些公司倾向于编写非常草率和不安全的代码，并相信因为源代码是封闭的，所以永远不会发现缺陷。

我们真正需要的是思考我们正在防范哪些威胁。避免 SSH 日志垃圾邮件与防范有决心的攻击者有点不同。在第一种情况下，移动 SSH 端口是有帮助的，但在第二种情况下则完全没有帮助。最后，我同意[Utku]的结论。晦涩不是一个安全的解决方案，但有时它可能是有用的。还有，既然他提到了端口敲门，我就不得不塞 [Fwknop](https://www.cipherdyne.org/fwknop/) 。这是端口敲门的想法，但真正的加密，而不仅仅是默默无闻。