# 火狐带来了火:从 GLX 转移到 EGL

> 原文：<https://hackaday.com/2021/11/23/firefox-brings-the-fire-shifting-from-glx-to-egl/>

你可能听说过(也可能没听说过)Firefox 的 Linux 图形堆栈正从 GLX 转移到 EGL。这是软件世界潮流走向的指示器。让我们看看这意味着什么，为什么它很重要，为什么它很酷。

图形堆栈是一个有许多层的复杂系统。但是在 Linux 上，像 OpenGL 和 T2 X11 和 T3 这样的窗口系统之间需要一个接口。X11 为在显示器上绘制和移动窗口、捕捉用户输入和确定焦点提供了一个基本框架，但仅此而已。X11 服务器只是一个管理所有窗口(客户端)的程序。X11 中的每个窗口都被视为一个客户端。客户端通过 Unix 进程套接字或互联网连接到服务器。

OpenGL 关注的是在窗口系统给定的屏幕空间范围内绘制什么。GLX(代表 X 窗口系统的 OpenGL 扩展)最初是由 Silicon Graphics 开发的。多年来，它已经发生了变化，获得了硬件加速支持和 DRI(直接渲染接口)。如果服务器和客户端在同一台计算机上，DRI 是 OpenGL 与图形硬件直接对话的一种方式。在其核心，GLX 为 X11 提供了 OpenGL 功能，通过允许发送 3d 渲染命令添加到 X 协议，以及读取渲染命令并将其传递给 OpenGL 的扩展。

EGL(嵌入式系统图形库)是 GLX 的继任者，但它的出发点是不同的环境。最初，焦点是嵌入式系统，Android、Raspberry Pi 和 Blackberry 等设备严重依赖 EGL 来满足其图形需求。然而，最终韦兰决定使用 EGL，因为 GLX 带来了 X11 依赖，EGL 提供了更接近硬件的途径。

当 Martin Stránsk 最初为 Firefox 添加 Wayland 支持时，他使用的是 EGL 而不是 GLX。此外，Wayland 实现通过 DMABUF(一个用于共享缓冲区的 Linux 内核子系统)实现了零拷贝 GPU 缓冲区共享。不幸的是，Firefox 无法为 X11 打开这一改进的 WebGL 性能(它存在，但从未足够稳定)。尽管如此，特色不断涌现，使得韦兰(以及随之而来的 EGL)成为更加一流的公民。现在，EGL 将在 Firefox 94+中默认启用，带有 Mesa 21+驱动程序(Mesa 是 OpenGL、Vulkan 和其他将命令翻译成 GPU 可以理解的指令的规范的实现)。

## 为什么这一举措如此重要

如前所述，EGL 有两个关键特性:零拷贝共享缓冲区和部分损坏支持。零拷贝意味着 WebGL 可以被沙盒化并且速度很快。部分损坏意味着如果只更改了一小部分，就不需要重绘整个窗口，从而节省了电力。这种转变也反映了软件世界的潮流。缓慢但肯定的是，世界正朝着 EGL/韦兰风格的合成发展。这种变化主要意味着更少的抽象和层次，以及更接近硬件。EGL 受益于更新和(希望)更少的奇怪的边缘情况。此外，默认情况下在 Firefox 中本地运行 Wayland，而不是通过 XWayland，这是一个重大转变。

有趣的是，尝试过它的人说性能提升非常显著，尤其是在看视频的时候。对于许多 GPU 来说，共享缓冲区有助于视频解码(将 h.264 等压缩流转换为原始位图)，然后进行合成。拥有共享的缓冲区和对硬件更近的访问允许 GPU 将解码的帧直接传输到合成器缓冲区，而不是访问 CPU RAM 并返回到 NUMA 机器的 GPU。

对我们许多人来说，Firefox 和其他极其复杂的程序是神秘的魔法盒子。窥探一下做出这些决定的人，以及他们是如何做出决定和权衡的，是非常有趣的。

好奇更多的 Linux 内部？为什么不[开始一次 main()](https://hackaday.com/2021/11/05/the-linux-x86-journey-to-main/) 之旅呢？