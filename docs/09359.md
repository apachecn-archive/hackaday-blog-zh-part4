# 本周安全:神秘的 Mac 恶意软件，优雅的 VMware RCE，以及 JSON 的混乱

> 原文:[https://hack aday . com/2021/02/26/this-week-in-security-mystery-MAC-malware-an-elegant-VMware-rce-and-a-JSON-mess/](https://hackaday.com/2021/02/26/this-week-in-security-mysterious-mac-malware-an-elegant-vmware-rce-and-a-json-mess/)

现在有一种针对 MacOS 的新恶意软件， [Silver Sparrow](https://redcanary.com/blog/clipping-silver-sparrows-wings/) ，它的不同寻常有几个原因。首先，它是针对新 M1 ARM64 处理器的少数恶意软件之一。提醒一下，那是苹果新的内部芯片设计。它不寻常的第二个原因是——它什么也没做。更准确地说，虽然研究人员一直在观察，但指挥和控制基础设施并没有提供有效载荷。已经在近 30，000 台机器上发现了 Silver Sparrow。

该恶意软件还有一个故意的 kill switch，即特定文件的出现会触发恶意软件包的完全删除。Red Canary 的研究人员指出，这个软件包的行为非常像一个合法的程序，很难被识别为恶意软件。 [Ars Technica 从苹果](https://arstechnica.com/information-technology/2021/02/new-malware-found-on-30000-macs-has-security-pros-stumped/)得到了一份非正式声明，表示他们正在跟踪情况，并且已经撤销了用于签署恶意软件的开发者证书。尚不完全清楚这是防止恶意软件在已经受损的机器上运行，还是仅仅阻止新的感染。

那么银雀的背后是谁？观察到的隐形模式和其他复杂性表明，这不仅仅是一个简单的广告软件或勒索软件活动。由于它是在有效载荷交付之前被发现的，我们可能永远不知道它的目的是什么。这可能是政府发起的运动，目标明确。

## VMware RCE

VMware 漏洞的[细节本周公布，这次攻击让我觉得相当优雅。CVE-2021-21972 是两个问题的结合。首先，VMware web 界面公开了一个不强制用户身份验证的 HTTP 端点。这个端点的功能之一是允许上传一个存档文件，并将其提取到`/tmp`目录中。第二个问题是提取函数没有正确地整理提取文件的名称。因此，有可能创建一个具有路径横向攻击的档案。](https://swarm.ptsecurity.com/unauth-rce-vmware/)

这里我们有两个非常简单的缺陷，当放在一起时，允许完全未经身份验证的参与者在运行 VMware 的机器上轻松执行任意代码。该攻击在 Linux 和 Windows 服务器上运行，实现方式可能会有所不同。

## 在无线安全系统内部

有没有想过住宅安全系统有多安全？来自 Tenable 的两位研究人员[Nick Miles]和[Chris Lyne]也想知道同样的事情，并决定拆开一个简单安全的系统，挖出它所有的秘密。他们从逻辑分析仪开始，直到支付芯片的功能解封，以恢复固件。

一步一步的过程是值得一读的，但是结论是这个系统被相对很好地组合在一起。每个设备都有一个不可变的 AES 密钥，这代表了一个攻击面，它不会出现在更健壮的密钥交换中。

出于好奇，[尼克]几个月前对一个环系统做了详细的分析。

## 恰到好处的功勋归属，简的故事

众所周知，当一个攻击或漏洞被归因于一个外国国家时，我会有点怀疑，但没有真正的证据。本周，一个故事引起了我的注意，因为这是一个很好的例子，说明了什么是正确的归属，更不用说是一个揭开恶意软件之谜的伟大例子。Check Point Research 深入调查了 APT31 利用的一个漏洞，该漏洞被认为是中国政府的一部分。

这里有太多的细节需要深入探讨，请阅读帖子了解详情，但我们会谈到重点。还记得 2017 年的[影子经纪人泄密](https://arstechnica.com/information-technology/2017/04/nsa-leaking-shadow-brokers-just-dumped-its-most-damaging-release-yet/)吗？这是一组令人印象深刻的 0 天，被公认为是由美国国家安全局下属的方程式小组制作的。其中一个工具是“EpMe”，它利用了 CVE-2017-0005。APT31 制作的漏洞利用剑也是针对这款的，很可能是 2014 年创作的。

有趣的是，Checkpoint 提出了一个非常令人信服的案例，表明两次攻击都针对同一个 CVE 并非偶然，而是中国的攻击基于一个捕获的 NSA 生产的工具样本。本质上，他们逆向工程的利用，并在自己的业务中使用它，甚至在工具被揭露的影子经纪人。

## Firefox 状态分区

Mozilla 发布了一项新的隐私功能，[状态划分](https://hacks.mozilla.org/2021/02/introducing-state-partitioning/)，这是一种权威地阻止基于 cookie 的在线跟踪的方式。这个概念看似简单。你访问的每个域名都有自己的“饼干罐”。许多网站有脸书 iframes 或嵌入图像。状态分区会隔离每个 iframes 创建的 cookies，这意味着你的浏览器对脸书来说是匿名的。

手拉手是一种新的 API，允许网站请求跨站点 cookie 访问。这对于少数合法使用需要访问的应用非常重要，比如单点登录服务。目前，默认情况下，分区是关闭的，可以通过增强的跟踪保护严格设置打开分区。

## JSON 未定义的行为

Bishop Fox Labs 的[杰克·米勒]为一个我从未考虑过的主题写了一篇很棒的介绍文章:奇怪的 JSON 构造，以及不同的实现如何处理它们。举个例子会有帮助。

```

obj = {"test": 1, "test": 2}

```

那么`obj["test"]`的值是多少呢？很复杂。有些 JSON 解析器会选择键的第一个定义，而有些会选择最后一个定义。还有一些人会抛出一个错误作为回应。使这成为一个特别严重的问题的是，在一个事务中，相同的数据可能被不同的实现解析。帖子中给出的例子是一个在线商店，支付处理由第三方处理。

该攻击通过操纵浏览器发送的 JSON 对象，为购买的商品数量注入第二个值定义来实现。商店本身看到的是更高的价值，这决定了实际发货的商品。支付后端使用不同的 JSON 解析器，它看到较小的值。后端实际上处理支付处理，因此收取的金额是较小的数量。

本文继续描述 JSON 中嵌入的无效 unicode 和已经被`/*commented out*/`的有效 keypairs 的问题，以及当您重新序列化这些古怪的数据时会发生什么。另一个有趣的例子是对非常大的数字的处理，有些解析器返回 0，有些返回 null，还有一些是科学符号的近似值。

总而言之，JSON 反序列化是一团糟。在使用多个解析器的 web 应用程序中，肯定会有许多难以发现的错误。作者在帖子的最后提出了几点建议。最重要的是，解析器应该在特定的古怪 JSON 输入上产生致命错误，而不是返回预期数据的猜测。